diff --git a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/DirectPostingsFormat.java b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/DirectPostingsFormat.java
index e7fd3dae..731b1a5e 100644
--- a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/DirectPostingsFormat.java
+++ b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/DirectPostingsFormat.java
@@ -1497,6 +1497,11 @@ public int advance(int target) {
       }
       return docID();
     }
+    
+    @Override
+    public long cost() {
+      return postings.length;
+    }
   }
 
   // Docs + freqs:
@@ -1562,6 +1567,11 @@ public int advance(int target) {
       }
       return docID();
     }
+    
+    @Override
+    public long cost() {
+      return postings.length / 2;
+    }
   }
 
   // Docs + freqs + positions/offets:
@@ -1643,6 +1653,12 @@ public int advance(int target) {
       }
       return docID();
     }
+    
+    @Override
+    public long cost() {
+      // TODO: could do a better estimate
+      return postings.length / 2;
+    }
   }
 
   private final static class LowFreqDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -1795,6 +1811,12 @@ public BytesRef getPayload() {
         return null;
       }
     }
+    
+    @Override
+    public long cost() {
+      // TODO: could do a better estimate
+      return postings.length / 2;
+    }
   }
 
   // Docs + freqs:
@@ -1968,6 +1990,11 @@ public int advance(int target) {
         return docID = docIDs[upto];
       }
     }
+    
+    @Override
+    public long cost() {
+      return docIDs.length;
+    }
   }
 
   // TODO: specialize offsets and not
@@ -2201,5 +2228,10 @@ public BytesRef getPayload() {
         return payload;
       }
     }
+    
+    @Override
+    public long cost() {
+      return docIDs.length;
+    }
   }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/MemoryPostingsFormat.java b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/MemoryPostingsFormat.java
index d36f5dae..d30be675 100644
--- a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/MemoryPostingsFormat.java
+++ b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/memory/MemoryPostingsFormat.java
@@ -431,6 +431,11 @@ public int advance(int target) {
     public int freq() {
       return freq;
     }
+    
+    @Override
+    public long cost() {
+      return numDocs;
+    }
   }
 
   private final static class FSTDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -618,6 +623,11 @@ public int advance(int target) {
     public int freq() {
       return freq;
     }
+    
+    @Override
+    public long cost() {
+      return numDocs;
+    }
   }
 
   private final static class FSTTermsEnum extends TermsEnum {
diff --git a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/pulsing/PulsingPostingsReader.java b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/pulsing/PulsingPostingsReader.java
index 914f2368..d0953cd9 100644
--- a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/pulsing/PulsingPostingsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/pulsing/PulsingPostingsReader.java
@@ -260,6 +260,7 @@ public DocsAndPositionsEnum docsAndPositions(FieldInfo field, BlockTermState _te
     private int accum;
     private int freq;
     private int payloadLength;
+    private int cost;
 
     public PulsingDocsEnum(FieldInfo fieldInfo) {
       indexOptions = fieldInfo.getIndexOptions();
@@ -283,6 +284,7 @@ public PulsingDocsEnum reset(Bits liveDocs, PulsingTermState termState) {
       docID = -1;
       accum = 0;
       freq = 1;
+      cost = termState.docFreq;
       payloadLength = 0;
       this.liveDocs = liveDocs;
       return this;
@@ -367,6 +369,11 @@ public int advance(int target) throws IOException {
       }
       return docID = NO_MORE_DOCS;
     }
+    
+    @Override
+    public long cost() {
+      return cost;
+    }
   }
 
   private static class PulsingDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -390,6 +397,7 @@ public int advance(int target) throws IOException {
     private int offsetLength;
 
     private boolean payloadRetrieved;
+    private int cost;
 
     public PulsingDocsAndPositionsEnum(FieldInfo fieldInfo) {
       indexOptions = fieldInfo.getIndexOptions();
@@ -415,6 +423,7 @@ public PulsingDocsAndPositionsEnum reset(Bits liveDocs, PulsingTermState termSta
       posPending = 0;
       docID = -1;
       accum = 0;
+      cost = termState.docFreq;
       startOffset = storeOffsets ? 0 : -1; // always return -1 if no offsets are stored
       offsetLength = 0;
       //System.out.println("PR d&p reset storesPayloads=" + storePayloads + " bytes=" + bytes.length + " this=" + this);
@@ -551,6 +560,11 @@ public BytesRef getPayload() throws IOException {
         return null;
       }
     }
+    
+    @Override
+    public long cost() {
+      return cost;
+    }
   }
 
   @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/sep/SepPostingsReader.java b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/sep/SepPostingsReader.java
index 53f902b7..9334dca8 100644
--- a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/sep/SepPostingsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/sep/SepPostingsReader.java
@@ -441,6 +441,11 @@ public int advance(int target) throws IOException {
 
       return doc;
     }
+    
+    @Override
+    public long cost() {
+      return docFreq;
+    }
   }
 
   class SepDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -717,5 +722,10 @@ public BytesRef getPayload() throws IOException {
       pendingPayloadBytes = 0;
       return payload;
     }
+    
+    @Override
+    public long cost() {
+      return docFreq;
+    }
   }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextFieldsReader.java b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextFieldsReader.java
index febe68ce..514006fd 100644
--- a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextFieldsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextFieldsReader.java
@@ -199,7 +199,7 @@ public DocsEnum docs(Bits liveDocs, DocsEnum reuse, int flags) throws IOExceptio
       } else {
         docsEnum = new SimpleTextDocsEnum();
       }
-      return docsEnum.reset(docsStart, liveDocs, indexOptions == IndexOptions.DOCS_ONLY);
+      return docsEnum.reset(docsStart, liveDocs, indexOptions == IndexOptions.DOCS_ONLY, docFreq);
     }
 
     @Override
@@ -216,7 +216,7 @@ public DocsAndPositionsEnum docsAndPositions(Bits liveDocs, DocsAndPositionsEnum
       } else {
         docsAndPositionsEnum = new SimpleTextDocsAndPositionsEnum();
       } 
-      return docsAndPositionsEnum.reset(docsStart, liveDocs, indexOptions);
+      return docsAndPositionsEnum.reset(docsStart, liveDocs, indexOptions, docFreq);
     }
     
     @Override
@@ -234,6 +234,7 @@ public DocsAndPositionsEnum docsAndPositions(Bits liveDocs, DocsAndPositionsEnum
     private Bits liveDocs;
     private final BytesRef scratch = new BytesRef(10);
     private final CharsRef scratchUTF16 = new CharsRef(10);
+    private int cost;
     
     public SimpleTextDocsEnum() {
       this.inStart = SimpleTextFieldsReader.this.in;
@@ -244,12 +245,13 @@ public boolean canReuse(IndexInput in) {
       return in == inStart;
     }
 
-    public SimpleTextDocsEnum reset(long fp, Bits liveDocs, boolean omitTF) throws IOException {
+    public SimpleTextDocsEnum reset(long fp, Bits liveDocs, boolean omitTF, int docFreq) throws IOException {
       this.liveDocs = liveDocs;
       in.seek(fp);
       this.omitTF = omitTF;
       docID = -1;
       tf = 1;
+      cost = docFreq;
       return this;
     }
 
@@ -316,6 +318,11 @@ public int advance(int target) throws IOException {
       while(nextDoc() < target);
       return docID;
     }
+    
+    @Override
+    public long cost() {
+      return cost;
+    }
   }
 
   private class SimpleTextDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -334,6 +341,7 @@ public int advance(int target) throws IOException {
     private boolean readPositions;
     private int startOffset;
     private int endOffset;
+    private int cost;
 
     public SimpleTextDocsAndPositionsEnum() {
       this.inStart = SimpleTextFieldsReader.this.in;
@@ -344,7 +352,7 @@ public boolean canReuse(IndexInput in) {
       return in == inStart;
     }
 
-    public SimpleTextDocsAndPositionsEnum reset(long fp, Bits liveDocs, IndexOptions indexOptions) {
+    public SimpleTextDocsAndPositionsEnum reset(long fp, Bits liveDocs, IndexOptions indexOptions, int docFreq) {
       this.liveDocs = liveDocs;
       nextDocStart = fp;
       docID = -1;
@@ -354,6 +362,7 @@ public SimpleTextDocsAndPositionsEnum reset(long fp, Bits liveDocs, IndexOptions
         startOffset = -1;
         endOffset = -1;
       }
+      cost = docFreq;
       return this;
     }
 
@@ -471,6 +480,11 @@ public int endOffset() throws IOException {
     public BytesRef getPayload() {
       return payload;
     }
+    
+    @Override
+    public long cost() {
+      return cost;
+    }
   }
 
   static class TermData {
diff --git a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextTermVectorsReader.java b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextTermVectorsReader.java
index bbc7c343..ea44a4b3 100644
--- a/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextTermVectorsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextTermVectorsReader.java
@@ -445,6 +445,11 @@ public void reset(Bits liveDocs, int freq) {
       this.doc = -1;
       didNext = false;
     }
+    
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
   
   private static class SimpleTVDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -536,5 +541,10 @@ public int endOffset() {
         return endOffsets[nextPos-1];
       }
     }
+    
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsAndPositionsEnum.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsAndPositionsEnum.java
index 30899b3e..34aa53be 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsAndPositionsEnum.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsAndPositionsEnum.java
@@ -134,5 +134,14 @@ public int endOffset() throws IOException {
   public BytesRef getPayload() throws IOException {
     return current.getPayload();
   }
+
+  @Override
+  public long cost() {
+    long cost = 0;
+    for (EnumWithSlice enumWithSlice : subs) {
+      cost += enumWithSlice.docsAndPositionsEnum.cost();
+    }
+    return cost;
+  }
 }
 
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsEnum.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsEnum.java
index 02037503..7f9252a0 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsEnum.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/MappingMultiDocsEnum.java
@@ -114,5 +114,14 @@ public int nextDoc() throws IOException {
       }
     }
   }
+  
+  @Override
+  public long cost() {
+    long cost = 0;
+    for (EnumWithSlice enumWithSlice : subs) {
+      cost += enumWithSlice.docsEnum.cost();
+    }
+    return cost;
+  }
 }
 
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/compressing/CompressingTermVectorsReader.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/compressing/CompressingTermVectorsReader.java
index 2bdbaf51..f9f0db1b 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/compressing/CompressingTermVectorsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/compressing/CompressingTermVectorsReader.java
@@ -1037,6 +1037,10 @@ public int advance(int target) throws IOException {
       }
     }
 
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 
   private static int sum(int[] arr) {
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xFields.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xFields.java
index 8d92e69c..03d509d0 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xFields.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xFields.java
@@ -989,6 +989,11 @@ public int freq() throws IOException {
     public int docID() {
       return docID;
     }
+    
+    @Override
+    public long cost() {
+      return docs.df;
+    }
   }
 
   private final class PreDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -1057,5 +1062,10 @@ public int endOffset() throws IOException {
     public BytesRef getPayload() throws IOException {
       return pos.getPayload();
     }
+    
+    @Override
+    public long cost() {
+      return pos.df;
+    }
   }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xTermVectorsReader.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xTermVectorsReader.java
index 4cd66a1c..8fb0b0e7 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xTermVectorsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene3x/Lucene3xTermVectorsReader.java
@@ -587,6 +587,11 @@ public void reset(Bits liveDocs, TermAndPostings termAndPostings) {
       this.doc = -1;
       didNext = false;
     }
+
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 
   private static class TVDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -677,6 +682,11 @@ public int endOffset() {
         return -1;
       }
     }
+    
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 
   @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40PostingsReader.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40PostingsReader.java
index a3729e2f..9c2c86fc 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40PostingsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40PostingsReader.java
@@ -513,6 +513,11 @@ private final int skipTo(int target) throws IOException {
       }
       return scanTo(target);
     }
+    
+    @Override
+    public long cost() {
+      return limit;
+    }
   }
   
   private final class AllDocsSegmentDocsEnum extends SegmentDocsEnumBase {
@@ -886,6 +891,11 @@ public int endOffset() {
     public BytesRef getPayload() throws IOException {
       return null;
     }
+    
+    @Override
+    public long cost() {
+      return limit;
+    }
   }
   
   // Decodes docs & positions & (payloads and/or offsets)
@@ -1179,5 +1189,10 @@ public BytesRef getPayload() throws IOException {
         return null;
       }
     }
+    
+    @Override
+    public long cost() {
+      return limit;
+    }
   }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40TermVectorsReader.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40TermVectorsReader.java
index 628090ab..21af2426 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40TermVectorsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene40/Lucene40TermVectorsReader.java
@@ -619,6 +619,11 @@ public void reset(Bits liveDocs, int freq) {
       this.doc = -1;
       didNext = false;
     }
+    
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 
   private static class TVDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -726,6 +731,11 @@ public int endOffset() {
         return endOffsets[nextPos-1];
       }
     }
+    
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 
   @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene41/Lucene41PostingsReader.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene41/Lucene41PostingsReader.java
index aa2f10fd..500ab204 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene41/Lucene41PostingsReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/codecs/lucene41/Lucene41PostingsReader.java
@@ -599,6 +599,11 @@ public int advance(int target) throws IOException {
         return nextDoc();
       }
     }
+    
+    @Override
+    public long cost() {
+      return docFreq;
+    }
   }
 
 
@@ -1010,6 +1015,11 @@ public int endOffset() {
     public BytesRef getPayload() {
       return null;
     }
+    
+    @Override
+    public long cost() {
+      return docFreq;
+    }
   }
 
   // Also handles payloads + offsets
@@ -1588,5 +1598,10 @@ public BytesRef getPayload() {
         return payload;
       }
     }
+    
+    @Override
+    public long cost() {
+      return docFreq;
+    }
   }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/FilterAtomicReader.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/FilterAtomicReader.java
index 503c7e41..9edc149c 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/FilterAtomicReader.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/FilterAtomicReader.java
@@ -256,6 +256,11 @@ public int advance(int target) throws IOException {
     public AttributeSource attributes() {
       return in.attributes();
     }
+
+    @Override
+    public long cost() {
+      return in.cost();
+    }
   }
 
   /** Base class for filtering {@link DocsAndPositionsEnum} implementations. */
@@ -315,6 +320,11 @@ public BytesRef getPayload() throws IOException {
     public AttributeSource attributes() {
       return in.attributes();
     }
+    
+    @Override
+    public long cost() {
+      return in.cost();
+    }
   }
 
   /** The underlying AtomicReader. */
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsAndPositionsEnum.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsAndPositionsEnum.java
index 7942f62a..2514c23c 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsAndPositionsEnum.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsAndPositionsEnum.java
@@ -169,6 +169,15 @@ public String toString() {
     }
   }
   
+  @Override
+  public long cost() {
+    long cost = 0;
+    for (int i = 0; i < numSubs; i++) {
+      cost += subs[i].docsAndPositionsEnum.cost();
+    }
+    return cost;
+  }
+  
   @Override
   public String toString() {
     return "MultiDocsAndPositionsEnum(" + Arrays.toString(getSubs()) + ")";
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsEnum.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsEnum.java
index b6d130a3..604143be 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsEnum.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/index/MultiDocsEnum.java
@@ -132,6 +132,15 @@ public int nextDoc() throws IOException {
     }
   }
 
+  @Override
+  public long cost() {
+    long cost = 0;
+    for (int i = 0; i < numSubs; i++) {
+      cost += subs[i].docsEnum.cost();
+    }
+    return cost;
+  }
+
   // TODO: implement bulk read more efficiently than super
   /** Holds a {@link DocsEnum} along with the
    *  corresponding {@link ReaderSlice}. */
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanQuery.java
index 487cece6..a5517866 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanQuery.java
@@ -21,15 +21,10 @@
 import java.util.*;
 
 import org.apache.lucene.index.AtomicReaderContext;
-import org.apache.lucene.index.DocsEnum;
 import org.apache.lucene.index.IndexReader;
 import org.apache.lucene.index.Term;
-import org.apache.lucene.index.TermsEnum;
 import org.apache.lucene.search.BooleanClause.Occur;
-import org.apache.lucene.search.ConjunctionTermScorer.DocsAndFreqs;
-import org.apache.lucene.search.TermQuery.TermWeight;
 import org.apache.lucene.search.similarities.Similarity;
-import org.apache.lucene.search.similarities.Similarity.ExactSimScorer;
 import org.apache.lucene.util.Bits;
 import org.apache.lucene.util.ToStringUtils;
 
@@ -174,24 +169,18 @@ public void add(BooleanClause clause) {
     protected ArrayList<Weight> weights;
     protected int maxCoord;  // num optional + num required
     private final boolean disableCoord;
-    private final boolean termConjunction;
 
     public BooleanWeight(IndexSearcher searcher, boolean disableCoord)
       throws IOException {
       this.similarity = searcher.getSimilarity();
       this.disableCoord = disableCoord;
       weights = new ArrayList<Weight>(clauses.size());
-      boolean termConjunction = clauses.isEmpty() || minNrShouldMatch != 0 ? false : true;
       for (int i = 0 ; i < clauses.size(); i++) {
         BooleanClause c = clauses.get(i);
         Weight w = c.getQuery().createWeight(searcher);
-        if (!(c.isRequired() && (w instanceof TermWeight))) {
-          termConjunction = false;
-        }
         weights.add(w);
         if (!c.isProhibited()) maxCoord++;
       }
-      this.termConjunction = termConjunction;
     }
 
     @Override
@@ -310,10 +299,6 @@ public Explanation explain(AtomicReaderContext context, int doc)
     public Scorer scorer(AtomicReaderContext context, boolean scoreDocsInOrder,
         boolean topScorer, Bits acceptDocs)
         throws IOException {
-      if (termConjunction) {
-        // specialized scorer for term conjunctions
-        return createConjunctionTermScorer(context, acceptDocs);
-      }
       List<Scorer> required = new ArrayList<Scorer>();
       List<Scorer> prohibited = new ArrayList<Scorer>();
       List<Scorer> optional = new ArrayList<Scorer>();
@@ -356,30 +341,13 @@ public Scorer scorer(AtomicReaderContext context, boolean scoreDocsInOrder,
         return null;
       }
       
-      // Return a BooleanScorer2
-      return new BooleanScorer2(this, disableCoord, minNrShouldMatch, required, prohibited, optional, maxCoord);
+      if (optional.size() == 0 && prohibited.size() == 0) {
+        float coord = disableCoord ? 1.0f : coord(required.size(), maxCoord);
+        return new ConjunctionScorer(this, required.toArray(new Scorer[required.size()]), coord);
     }
 
-    private Scorer createConjunctionTermScorer(AtomicReaderContext context, Bits acceptDocs)
-        throws IOException {
-
-      // TODO: fix scorer API to specify "needsScores" up
-      // front, so we can do match-only if caller doesn't
-      // needs scores
-
-      final DocsAndFreqs[] docsAndFreqs = new DocsAndFreqs[weights.size()];
-      for (int i = 0; i < docsAndFreqs.length; i++) {
-        final TermWeight weight = (TermWeight) weights.get(i);
-        final Scorer scorer = weight.scorer(context, true, false, acceptDocs);
-        if (scorer == null) {
-          return null;
-        } else {
-          assert scorer instanceof TermScorer;
-          docsAndFreqs[i] = new DocsAndFreqs((TermScorer) scorer);
-        }
-      }
-      return new ConjunctionTermScorer(this, disableCoord ? 1.0f : coord(
-          docsAndFreqs.length, docsAndFreqs.length), docsAndFreqs);
+      // Return a BooleanScorer2
+      return new BooleanScorer2(this, disableCoord, minNrShouldMatch, required, prohibited, optional, maxCoord);
     }
     
     @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer.java
index 6cba54fa..c4702903 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer.java
@@ -135,6 +135,9 @@ public boolean acceptsDocsOutOfOrder() {
     @Override
     public float score() { return (float)score; }
     
+    @Override
+    public long cost() { return 1; }
+
   }
 
   static final class Bucket {
@@ -326,6 +329,11 @@ public int freq() throws IOException {
     throw new UnsupportedOperationException();
   }
 
+  @Override
+  public long cost() {
+    return Integer.MAX_VALUE;
+  }
+
   @Override
   public void score(Collector collector) throws IOException {
     score(collector, Integer.MAX_VALUE, -1);
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer2.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer2.java
index db967283..a26a2169 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer2.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/BooleanScorer2.java
@@ -147,6 +147,11 @@ public int nextDoc() throws IOException {
     public int advance(int target) throws IOException {
       return scorer.advance(target);
     }
+
+    @Override
+    public long cost() {
+      return scorer.cost();
+    }
   }
 
   private Scorer countingDisjunctionSumScorer(final List<Scorer> scorers,
@@ -175,7 +180,7 @@ private Scorer countingConjunctionSumScorer(boolean disableCoord,
                                               List<Scorer> requiredScorers) throws IOException {
     // each scorer from the list counted as a single matcher
     final int requiredNrMatchers = requiredScorers.size();
-    return new ConjunctionScorer(weight, requiredScorers) {
+    return new ConjunctionScorer(weight, requiredScorers.toArray(new Scorer[requiredScorers.size()])) {
       private int lastScoredDoc = -1;
       // Save the score of lastScoredDoc, so that we don't compute it more than
       // once in score().
@@ -200,7 +205,7 @@ private Scorer countingConjunctionSumScorer(boolean disableCoord,
 
   private Scorer dualConjunctionSumScorer(boolean disableCoord,
                                                 Scorer req1, Scorer req2) throws IOException { // non counting.
-    return new ConjunctionScorer(weight, req1, req2);
+    return new ConjunctionScorer(weight, new Scorer[] { req1, req2 });
     // All scorers match, so defaultSimilarity always has 1 as
     // the coordination factor.
     // Therefore the sum of the scores of two scorers
@@ -322,6 +327,11 @@ public int advance(int target) throws IOException {
     return doc = countingSumScorer.advance(target);
   }
 
+  @Override
+  public long cost() {
+    return countingSumScorer.cost();
+  }
+
   @Override
   public Collection<ChildScorer> getChildren() {
     ArrayList<ChildScorer> children = new ArrayList<ChildScorer>();
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/CachingCollector.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/CachingCollector.java
index deaafeca..554da526 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/CachingCollector.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/CachingCollector.java
@@ -89,6 +89,9 @@ public SegStart(AtomicReaderContext readerContext, int end) {
     
     @Override
     public final int nextDoc() { throw new UnsupportedOperationException(); }
+    
+    @Override
+    public long cost() { return 1; }
     }
 
   // A CachingCollector which caches scores
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionScorer.java
index c2fa36e3..2fb36f6b 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionScorer.java
@@ -17,99 +17,76 @@
  * limitations under the License.
  */
 
-import org.apache.lucene.util.ArrayUtil;
 import java.io.IOException;
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Comparator;
 
+import org.apache.lucene.util.ArrayUtil;
+
 /** Scorer for conjunctions, sets of queries, all of which are required. */
 class ConjunctionScorer extends Scorer {
+  protected int lastDoc = -1;
+  protected final DocsAndFreqs[] docsAndFreqs;
+  private final DocsAndFreqs lead;
+  private final float coord;
   
-  private final Scorer[] scorers;
-  private int lastDoc = -1;
-
-  public ConjunctionScorer(Weight weight, Collection<Scorer> scorers) throws IOException {
-    this(weight, scorers.toArray(new Scorer[scorers.size()]));
+  ConjunctionScorer(Weight weight, Scorer[] scorers) {
+    this(weight, scorers, 1f);
   }
 
-  public ConjunctionScorer(Weight weight, Scorer... scorers) throws IOException {
+  ConjunctionScorer(Weight weight, Scorer[] scorers, float coord) {
     super(weight);
-    this.scorers = scorers;
-    
+    this.coord = coord;
+    this.docsAndFreqs = new DocsAndFreqs[scorers.length];
     for (int i = 0; i < scorers.length; i++) {
-      if (scorers[i].nextDoc() == NO_MORE_DOCS) {
-        // If even one of the sub-scorers does not have any documents, this
-        // scorer should not attempt to do any more work.
-        lastDoc = NO_MORE_DOCS;
-        return;
-      }
+      docsAndFreqs[i] = new DocsAndFreqs(scorers[i]);
     }
-
-    // Sort the array the first time...
-    // We don't need to sort the array in any future calls because we know
-    // it will already start off sorted (all scorers on same doc).
-    
-    // Note that this comparator is not consistent with equals!
-    // Also we use mergeSort here to be stable (so order of Scoreres that
-    // match on first document keeps preserved):
-    ArrayUtil.mergeSort(scorers, new Comparator<Scorer>() { // sort the array
+    // Sort the array the first time to allow the least frequent DocsEnum to
+    // lead the matching.
+    ArrayUtil.mergeSort(docsAndFreqs, new Comparator<DocsAndFreqs>() {
       @Override
-      public int compare(Scorer o1, Scorer o2) {
-        return o1.docID() - o2.docID();
+      public int compare(DocsAndFreqs o1, DocsAndFreqs o2) {
+        return Long.signum(o1.cost - o2.cost);
       }
     });
 
-    // NOTE: doNext() must be called before the re-sorting of the array later on.
-    // The reason is this: assume there are 5 scorers, whose first docs are 1,
-    // 2, 3, 5, 5 respectively. Sorting (above) leaves the array as is. Calling
-    // doNext() here advances all the first scorers to 5 (or a larger doc ID
-    // they all agree on). 
-    // However, if we re-sort before doNext() is called, the order will be 5, 3,
-    // 2, 1, 5 and then doNext() will stop immediately, since the first scorer's
-    // docs equals the last one. So the invariant that after calling doNext() 
-    // all scorers are on the same doc ID is broken.
-    if (doNext() == NO_MORE_DOCS) {
-      // The scorers did not agree on any document.
-      lastDoc = NO_MORE_DOCS;
-      return;
-    }
-
-    // If first-time skip distance is any predictor of
-    // scorer sparseness, then we should always try to skip first on
-    // those scorers.
-    // Keep last scorer in it's last place (it will be the first
-    // to be skipped on), but reverse all of the others so that
-    // they will be skipped on in order of original high skip.
-    int end = scorers.length - 1;
-    int max = end >> 1;
-    for (int i = 0; i < max; i++) {
-      Scorer tmp = scorers[i];
-      int idx = end - i - 1;
-      scorers[i] = scorers[idx];
-      scorers[idx] = tmp;
-    }
+    lead = docsAndFreqs[0]; // least frequent DocsEnum leads the intersection
   }
 
-  private int doNext() throws IOException {
-    int first = 0;
-    int doc = scorers[scorers.length - 1].docID();
-    Scorer firstScorer;
-    while ((firstScorer = scorers[first]).docID() < doc) {
-      doc = firstScorer.advance(doc);
-      first = first == scorers.length - 1 ? 0 : first + 1;
+  private int doNext(int doc) throws IOException {
+    for(;;) {
+      // doc may already be NO_MORE_DOCS here, but we don't check explicitly
+      // since all scorers should advance to NO_MORE_DOCS, match, then
+      // return that value.
+      advanceHead: for(;;) {
+        for (int i = 1; i < docsAndFreqs.length; i++) {
+          // invariant: docsAndFreqs[i].doc <= doc at this point.
+
+          // docsAndFreqs[i].doc may already be equal to doc if we "broke advanceHead"
+          // on the previous iteration and the advance on the lead scorer exactly matched.
+          if (docsAndFreqs[i].doc < doc) {
+            docsAndFreqs[i].doc = docsAndFreqs[i].scorer.advance(doc);
+
+            if (docsAndFreqs[i].doc > doc) {
+              // DocsEnum beyond the current doc - break and advance lead to the new highest doc.
+              doc = docsAndFreqs[i].doc;
+              break advanceHead;
+            }
+          }
     }
+        // success - all DocsEnums are on the same doc
     return doc;
   }
+      // advance head for next iteration
+      doc = lead.doc = lead.scorer.advance(doc);
+    }
+  }
   
   @Override
   public int advance(int target) throws IOException {
-    if (lastDoc == NO_MORE_DOCS) {
-      return lastDoc;
-    } else if (scorers[(scorers.length - 1)].docID() < target) {
-      scorers[(scorers.length - 1)].advance(target);
-    }
-    return lastDoc = doNext();
+    lead.doc = lead.scorer.advance(target);
+    return lastDoc = doNext(lead.doc);
   }
 
   @Override
@@ -119,36 +96,47 @@ public int docID() {
   
   @Override
   public int nextDoc() throws IOException {
-    if (lastDoc == NO_MORE_DOCS) {
-      return lastDoc;
-    } else if (lastDoc == -1) {
-      return lastDoc = scorers[scorers.length - 1].docID();
-    }
-    scorers[(scorers.length - 1)].nextDoc();
-    return lastDoc = doNext();
+    lead.doc = lead.scorer.nextDoc();
+    return lastDoc = doNext(lead.doc);
   }
   
   @Override
   public float score() throws IOException {
     // TODO: sum into a double and cast to float if we ever send required clauses to BS1
     float sum = 0.0f;
-    for (int i = 0; i < scorers.length; i++) {
-      sum += scorers[i].score();
+    for (DocsAndFreqs docs : docsAndFreqs) {
+      sum += docs.scorer.score();
     }
-    return sum;
+    return sum * coord;
   }
 
   @Override
-  public int freq() throws IOException {
-    return scorers.length;
+  public int freq() {
+    return docsAndFreqs.length;
+  }
+
+  @Override
+  public long cost() {
+    return lead.scorer.cost();
   }
 
   @Override
   public Collection<ChildScorer> getChildren() {
-    ArrayList<ChildScorer> children = new ArrayList<ChildScorer>(scorers.length);
-    for (Scorer scorer : scorers) {
-      children.add(new ChildScorer(scorer, "MUST"));
+    ArrayList<ChildScorer> children = new ArrayList<ChildScorer>(docsAndFreqs.length);
+    for (DocsAndFreqs docs : docsAndFreqs) {
+      children.add(new ChildScorer(docs.scorer, "MUST"));
     }
     return children;
   }
+
+  static final class DocsAndFreqs {
+    final long cost;
+    final Scorer scorer;
+    int doc = -1;
+   
+    DocsAndFreqs(Scorer scorer) {
+      this.scorer = scorer;
+      this.cost = scorer.cost();
+    }
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionTermScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionTermScorer.java
index b48a94e6..e69de29b 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionTermScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConjunctionTermScorer.java
@@ -1,138 +0,0 @@
-package org.apache.lucene.search;
-
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import java.io.IOException;
-import java.util.ArrayList;
-import java.util.Collection;
-import java.util.Comparator;
-
-import org.apache.lucene.index.DocsEnum;
-import org.apache.lucene.util.ArrayUtil;
-
-/** Scorer for conjunctions, sets of terms, all of which are required. */
-class ConjunctionTermScorer extends Scorer {
-  protected final float coord;
-  protected int lastDoc = -1;
-  protected final DocsAndFreqs[] docsAndFreqs;
-  private final DocsAndFreqs lead;
-
-  ConjunctionTermScorer(Weight weight, float coord,
-      DocsAndFreqs[] docsAndFreqs) {
-    super(weight);
-    this.coord = coord;
-    this.docsAndFreqs = docsAndFreqs;
-    // Sort the array the first time to allow the least frequent DocsEnum to
-    // lead the matching.
-    ArrayUtil.mergeSort(docsAndFreqs, new Comparator<DocsAndFreqs>() {
-      @Override
-      public int compare(DocsAndFreqs o1, DocsAndFreqs o2) {
-        return o1.docFreq - o2.docFreq;
-      }
-    });
-
-    lead = docsAndFreqs[0]; // least frequent DocsEnum leads the intersection
-  }
-
-  private int doNext(int doc) throws IOException {
-    for(;;) {
-      // doc may already be NO_MORE_DOCS here, but we don't check explicitly
-      // since all scorers should advance to NO_MORE_DOCS, match, then
-      // return that value.
-      advanceHead: for(;;) {
-        for (int i = 1; i < docsAndFreqs.length; i++) {
-          // invariant: docsAndFreqs[i].doc <= doc at this point.
-
-          // docsAndFreqs[i].doc may already be equal to doc if we "broke advanceHead"
-          // on the previous iteration and the advance on the lead scorer exactly matched.
-          if (docsAndFreqs[i].doc < doc) {
-            docsAndFreqs[i].doc = docsAndFreqs[i].docs.advance(doc);
-
-            if (docsAndFreqs[i].doc > doc) {
-              // DocsEnum beyond the current doc - break and advance lead to the new highest doc.
-              doc = docsAndFreqs[i].doc;
-              break advanceHead;
-            }
-          }
-        }
-        // success - all DocsEnums are on the same doc
-        return doc;
-      }
-      // advance head for next iteration
-      doc = lead.doc = lead.docs.advance(doc);
-    }
-  }
-
-  @Override
-  public int advance(int target) throws IOException {
-    lead.doc = lead.docs.advance(target);
-    return lastDoc = doNext(lead.doc);
-  }
-
-  @Override
-  public int docID() {
-    return lastDoc;
-  }
-
-  @Override
-  public int nextDoc() throws IOException {
-    lead.doc = lead.docs.nextDoc();
-    return lastDoc = doNext(lead.doc);
-  }
-
-  @Override
-  public float score() throws IOException {
-    // TODO: sum into a double and cast to float if we ever send required clauses to BS1
-    float sum = 0.0f;
-    for (DocsAndFreqs docs : docsAndFreqs) {
-      sum += docs.scorer.score();
-    }
-    return sum * coord;
-  }
-  
-  @Override
-  public int freq() {
-    return docsAndFreqs.length;
-  }
-
-  @Override
-  public Collection<ChildScorer> getChildren() {
-    ArrayList<ChildScorer> children = new ArrayList<ChildScorer>(docsAndFreqs.length);
-    for (DocsAndFreqs docs : docsAndFreqs) {
-      children.add(new ChildScorer(docs.scorer, "MUST"));
-    }
-    return children;
-  }
-
-  static final class DocsAndFreqs {
-    final DocsEnum docs;
-    final int docFreq;
-    final Scorer scorer;
-    int doc = -1;
-
-    DocsAndFreqs(TermScorer termScorer) {
-      this(termScorer, termScorer.getDocsEnum(), termScorer.getDocFreq());
-    }
-    
-    DocsAndFreqs(Scorer scorer, DocsEnum docs, int docFreq) {
-      this.docs = docs;
-      this.docFreq = docFreq;
-      this.scorer = scorer;
-    }
-  }
-}
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConstantScoreQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConstantScoreQuery.java
index f6fd987b..6c4fe45c 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConstantScoreQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ConstantScoreQuery.java
@@ -206,6 +206,11 @@ public int advance(int target) throws IOException {
       return docIdSetIterator.advance(target);
     }
     
+    @Override
+    public long cost() {
+      return docIdSetIterator.cost();
+    }
+
     private Collector wrapCollector(final Collector collector) {
       return new Collector() {
         @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DisjunctionScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DisjunctionScorer.java
index 84bf866b..e711b508 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DisjunctionScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DisjunctionScorer.java
@@ -105,4 +105,13 @@ protected final void heapRemoveRoot() {
     }
     return children;
   }
+
+  @Override
+  public long cost() {
+    long sum = 0;
+    for (int i = 0; i < numScorers; i++) {
+      sum += subScorers[i].cost();
+    }
+    return sum;
+  } 
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSet.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSet.java
index a326c8ef..6df23b17 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSet.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSet.java
@@ -36,6 +36,8 @@
       public int docID() { return NO_MORE_DOCS; }
       @Override
       public int nextDoc() { return NO_MORE_DOCS; }
+      @Override
+      public long cost() { return 0; }
     };
     
     @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSetIterator.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSetIterator.java
index d5fc01b1..2a5f7292 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSetIterator.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/DocIdSetIterator.java
@@ -93,4 +93,12 @@
    */
   public abstract int advance(int target) throws IOException;
 
+  /**
+   * Returns the estimated cost of this {@link DocIdSetIterator}.
+   * <p>
+   * This is generally an upper bound of the number of documents this iterator
+   * might match, but may be a rough heuristic, hardcoded value, or otherwise
+   * completely inaccurate.
+   */
+  public abstract long cost();
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ExactPhraseScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ExactPhraseScorer.java
index ac4f0e32..fce33ad1 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ExactPhraseScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ExactPhraseScorer.java
@@ -33,6 +33,7 @@
   private final int[] gens = new int[CHUNK];
 
   boolean noDocs;
+  private final long cost;
 
   private final static class ChunkState {
     final DocsAndPositionsEnum posEnum;
@@ -66,6 +67,9 @@ public ChunkState(DocsAndPositionsEnum posEnum, int offset, boolean useAdvance)
 
     endMinus1 = postings.length-1;
 
+    // min(cost)
+    cost = postings[0].postings.cost();
+
     for(int i=0;i<postings.length;i++) {
 
       // Coarse optimization: advance(target) is fairly
@@ -315,4 +319,9 @@ private int phraseFreq() throws IOException {
 
     return freq;
   }
+
+  @Override
+  public long cost() {
+    return cost;
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FieldCacheDocIdSet.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FieldCacheDocIdSet.java
index 3f945c96..1a4d8e8d 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FieldCacheDocIdSet.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FieldCacheDocIdSet.java
@@ -111,6 +111,11 @@ public int advance(int target) {
           }
           return doc = NO_MORE_DOCS;
         }
+
+        @Override
+        public long cost() {
+          return maxDoc;
+        }
       };
     } else if (acceptDocs instanceof FixedBitSet || acceptDocs instanceof OpenBitSet) {
       // special case for FixedBitSet / OpenBitSet: use the iterator and filter it
@@ -151,6 +156,11 @@ public int advance(int target) {
           }
           return doc = NO_MORE_DOCS;
         }
+
+        @Override
+        public long cost() {
+          return maxDoc;
+        }
       };
     }
   }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredDocIdSetIterator.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredDocIdSetIterator.java
index 35c50bb7..534f7248 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredDocIdSetIterator.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredDocIdSetIterator.java
@@ -82,4 +82,8 @@ public int advance(int target) throws IOException {
     return doc;
   }
   
+  @Override
+  public long cost() {
+    return _innerIter.cost();
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredQuery.java
index 8cff6478..67b54b81 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/FilteredQuery.java
@@ -210,6 +210,11 @@ public float score() throws IOException {
     public Collection<ChildScorer> getChildren() {
       return Collections.singleton(new ChildScorer(scorer, "FILTERED"));
     }
+
+    @Override
+    public long cost() {
+      return scorer.cost();
+    }
   }
   
   /**
@@ -304,6 +309,11 @@ public final float score() throws IOException {
     public final Collection<ChildScorer> getChildren() {
       return Collections.singleton(new ChildScorer(scorer, "FILTERED"));
     }
+
+    @Override
+    public long cost() {
+      return Math.min(primary.cost(), secondary.cost());
+    }
   }
   
   // TODO once we have way to figure out if we use RA or LeapFrog we can remove this scorer
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/IndexSearcher.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/IndexSearcher.java
index fb862999..d56a3212 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/IndexSearcher.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/IndexSearcher.java
@@ -788,6 +788,11 @@ public int nextDoc() {
       public float score() {
         return score;
       }
+
+      @Override
+      public long cost() {
+        return 1;
+      }
     }
 
     private final FakeScorer fakeScorer = new FakeScorer();
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MatchAllDocsQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MatchAllDocsQuery.java
index 633586e0..0737a7cb 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MatchAllDocsQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MatchAllDocsQuery.java
@@ -77,6 +77,11 @@ public int advance(int target) throws IOException {
       doc = target-1;
       return nextDoc();
     }
+
+    @Override
+    public long cost() {
+      return maxDoc;
+    }
   }
 
   private class MatchAllDocsWeight extends Weight {
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MultiPhraseQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MultiPhraseQuery.java
index ddad80b0..0bcac051 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MultiPhraseQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/MultiPhraseQuery.java
@@ -472,6 +472,7 @@ private void growArray() {
   private int _freq;
   private DocsQueue _queue;
   private IntQueue _posList;
+  private long cost;
 
   public UnionDocsAndPositionsEnum(Bits liveDocs, AtomicReaderContext context, Term[] terms, Map<Term,TermContext> termContexts, TermsEnum termsEnum) throws IOException {
     List<DocsAndPositionsEnum> docsEnums = new LinkedList<DocsAndPositionsEnum>();
@@ -488,6 +489,7 @@ public UnionDocsAndPositionsEnum(Bits liveDocs, AtomicReaderContext context, Ter
         // term does exist, but has no positions
         throw new IllegalStateException("field \"" + term.field() + "\" was indexed without position data; cannot run PhraseQuery (term=" + term.text() + ")");
       }
+      cost += postings.cost();
       docsEnums.add(postings);
     }
 
@@ -570,4 +572,9 @@ public final int freq() {
   public final int docID() {
     return _doc;
   }
+
+  @Override
+  public long cost() {
+    return cost;
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqExclScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqExclScorer.java
index 2b53aebd..14a3cf29 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqExclScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqExclScorer.java
@@ -128,4 +128,9 @@ public int advance(int target) throws IOException {
     }
     return doc = toNonExcluded();
   }
+
+  @Override
+  public long cost() {
+    return reqScorer.cost();
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqOptSumScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqOptSumScorer.java
index 8ed6e278..4e1c40c5 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqOptSumScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ReqOptSumScorer.java
@@ -99,5 +99,10 @@ public int freq() throws IOException {
     children.add(new ChildScorer(optScorer, "SHOULD"));
     return children;
   }
+
+  @Override
+  public long cost() {
+    return reqScorer.cost();
+  }
 }
 
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ScoreCachingWrappingScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ScoreCachingWrappingScorer.java
index 41442371..f850f533 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ScoreCachingWrappingScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/ScoreCachingWrappingScorer.java
@@ -89,4 +89,9 @@ public int advance(int target) throws IOException {
   public Collection<ChildScorer> getChildren() {
     return Collections.singleton(new ChildScorer(scorer, "CACHED"));
   }
+
+  @Override
+  public long cost() {
+    return scorer.cost();
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/SloppyPhraseScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/SloppyPhraseScorer.java
index dca67fa9..a90adc60 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/SloppyPhraseScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/SloppyPhraseScorer.java
@@ -49,6 +49,7 @@
   private PhrasePositions[] rptStack; // temporary stack for switching colliding repeating pps 
   
   private int numMatches;
+  private final long cost;
   
   SloppyPhraseScorer(Weight weight, PhraseQuery.PostingsAndFreq[] postings,
       int slop, Similarity.SloppySimScorer docScorer) {
@@ -57,6 +58,8 @@
     this.slop = slop;
     this.numPostings = postings==null ? 0 : postings.length;
     pq = new PhraseQueue(postings.length);
+    // min(cost)
+    cost = postings[0].postings.cost();
     // convert tps to a list of phrase positions.
     // note: phrase-position differs from term-position in that its position
     // reflects the phrase offset: pp.pos = tp.pos - offset.
@@ -589,6 +592,11 @@ public int advance(int target) throws IOException {
     return max.doc;
   }
   
+  @Override
+  public long cost() {
+    return cost;
+  }
+
   @Override
   public String toString() { return "scorer(" + weight + ")"; }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermQuery.java
index 7f854f8c..fb5bfcc5 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermQuery.java
@@ -32,7 +32,6 @@
 import org.apache.lucene.search.similarities.Similarity.ExactSimScorer;
 import org.apache.lucene.search.similarities.Similarity;
 import org.apache.lucene.util.Bits;
-import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.ToStringUtils;
 
 /** A Query that matches documents containing a term.
@@ -85,7 +84,7 @@ public Scorer scorer(AtomicReaderContext context, boolean scoreDocsInOrder,
       }
       DocsEnum docs = termsEnum.docs(acceptDocs, null);
       assert docs != null;
-      return new TermScorer(this, docs, similarity.exactSimScorer(stats, context), termsEnum.docFreq());
+      return new TermScorer(this, docs, similarity.exactSimScorer(stats, context));
     }
     
     /**
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermScorer.java
index 3ccc55e1..2c57345c 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/TermScorer.java
@@ -27,7 +27,6 @@
 final class TermScorer extends Scorer {
   private final DocsEnum docsEnum;
   private final Similarity.ExactSimScorer docScorer;
-  private final int docFreq;
   
   /**
    * Construct a <code>TermScorer</code>.
@@ -39,14 +38,11 @@
    * @param docScorer
    *          The </code>Similarity.ExactSimScorer</code> implementation 
    *          to be used for score computations.
-   * @param docFreq
-   *          per-segment docFreq of this term
    */
-  TermScorer(Weight weight, DocsEnum td, Similarity.ExactSimScorer docScorer, int docFreq) {
+  TermScorer(Weight weight, DocsEnum td, Similarity.ExactSimScorer docScorer) {
     super(weight);
     this.docScorer = docScorer;
     this.docsEnum = td;
-    this.docFreq = docFreq;
   }
 
   @Override
@@ -89,21 +85,12 @@ public int advance(int target) throws IOException {
     return docsEnum.advance(target);
   }
 
-  /** Returns a string representation of this <code>TermScorer</code>. */
   @Override
-  public String toString() { return "scorer(" + weight + ")"; }
-
-  // TODO: benchmark if the specialized conjunction really benefits
-  // from this, or if instead its from sorting by docFreq, or both
-
-  DocsEnum getDocsEnum() {
-    return docsEnum;
+  public long cost() {
+    return docsEnum.cost();
   }
   
-  // TODO: generalize something like this for scorers?
-  // even this is just an estimation...
-  
-  int getDocFreq() {
-    return docFreq;
-  }
+  /** Returns a string representation of this <code>TermScorer</code>. */
+  @Override
+  public String toString() { return "scorer(" + weight + ")"; }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansOrdered.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansOrdered.java
index 6ba02536..959253ab 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansOrdered.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansOrdered.java
@@ -134,6 +134,15 @@ public boolean isPayloadAvailable() {
     return matchPayload.isEmpty() == false;
   }
 
+  @Override
+  public long cost() {
+    long minCost = Long.MAX_VALUE;
+    for (int i = 0; i < subSpans.length; i++) {
+      minCost = Math.min(minCost, subSpans[i].cost());
+    }
+    return minCost;
+  }
+
   // inherit javadocs
   @Override
   public boolean next() throws IOException {
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansUnordered.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansUnordered.java
index 42090c65..01219be1 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansUnordered.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/NearSpansUnordered.java
@@ -130,6 +130,11 @@ public boolean isPayloadAvailable() throws IOException {
       return spans.isPayloadAvailable();
     }
 
+    @Override
+    public long cost() {
+      return spans.cost();
+    }
+
     @Override
     public String toString() { return spans.toString() + "#" + index; }
   }
@@ -268,6 +273,15 @@ public boolean isPayloadAvailable() throws IOException {
     return false;
   }
 
+  @Override
+  public long cost() {
+    long minCost = Long.MAX_VALUE;
+    for (int i = 0; i < subSpans.length; i++) {
+      minCost = Math.min(minCost, subSpans[i].cost());
+    }
+    return minCost;
+  }
+
   @Override
   public String toString() {
     return getClass().getName() + "("+query.toString()+")@"+
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanNotQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanNotQuery.java
index 2e50a2e6..9bba5db6 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanNotQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanNotQuery.java
@@ -161,6 +161,11 @@ public boolean isPayloadAvailable() throws IOException {
         return includeSpans.isPayloadAvailable();
       }
 
+      @Override
+      public long cost() {
+        return includeSpans.cost();
+      }
+
       @Override
       public String toString() {
           return "spans(" + SpanNotQuery.this.toString() + ")";
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanOrQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanOrQuery.java
index 162a5d5d..689eb5e6 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanOrQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanOrQuery.java
@@ -172,12 +172,14 @@ public Spans getSpans(final AtomicReaderContext context, final Bits acceptDocs,
 
     return new Spans() {
         private SpanQueue queue = null;
+        private long cost;
 
         private boolean initSpanQueue(int target) throws IOException {
           queue = new SpanQueue(clauses.size());
           Iterator<SpanQuery> i = clauses.iterator();
           while (i.hasNext()) {
             Spans spans = i.next().getSpans(context, acceptDocs, termContexts);
+            cost += spans.cost();
             if (   ((target == -1) && spans.next())
                 || ((target != -1) && spans.skipTo(target))) {
               queue.add(spans);
@@ -259,6 +261,11 @@ public String toString() {
              :(queue.size()>0?(doc()+":"+start()+"-"+end()):"END"));
         }
 
+      @Override
+      public long cost() {
+        return cost;
+      }
+      
       };
   }
 
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanPositionCheckQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanPositionCheckQuery.java
index 5c12fc08..edb1e622 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanPositionCheckQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanPositionCheckQuery.java
@@ -180,6 +180,11 @@ public boolean isPayloadAvailable() throws IOException {
       return spans.isPayloadAvailable();
     }
 
+    @Override
+    public long cost() {
+      return spans.cost();
+    }
+
     @Override
     public String toString() {
         return "spans(" + SpanPositionCheckQuery.this.toString() + ")";
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanScorer.java
index cd594637..b1428c36 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/SpanScorer.java
@@ -107,4 +107,9 @@ public int freq() throws IOException {
   public float sloppyFreq() throws IOException {
     return freq;
   }
+  
+  @Override
+  public long cost() {
+    return spans.cost();
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/Spans.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/Spans.java
index a774c60f..3322aee5 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/Spans.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/Spans.java
@@ -84,4 +84,12 @@
    */
   public abstract boolean isPayloadAvailable() throws IOException;
   
+  /**
+   * Returns the estimated cost of this spans.
+   * <p>
+   * This is generally an upper bound of the number of documents this iterator
+   * might match, but may be a rough heuristic, hardcoded value, or otherwise
+   * completely inaccurate.
+   */
+  public abstract long cost();
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/TermSpans.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/TermSpans.java
index 314ca982..484f453c 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/TermSpans.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/search/spans/TermSpans.java
@@ -99,6 +99,11 @@ public int end() {
     return position + 1;
   }
 
+  @Override
+  public long cost() {
+    return postings.cost();
+  }
+
   // TODO: Remove warning after API has been finalized
   @Override
   public Collection<byte[]> getPayload() throws IOException {
@@ -166,6 +171,11 @@ public int end() {
     public boolean isPayloadAvailable() {
       return false;
     }
+
+    @Override
+    public long cost() {
+      return 0;
+    }
   }
 
   public static final TermSpans EMPTY_TERM_SPANS = new EmptyTermSpans();
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/DocIdBitSet.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/DocIdBitSet.java
index 1470de20..c5c35d57 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/DocIdBitSet.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/DocIdBitSet.java
@@ -95,5 +95,11 @@ public int advance(int target) {
       docId = d == -1 ? NO_MORE_DOCS : d;
       return docId;
     }
+    
+    @Override
+    public long cost() {
+      // upper bound
+      return bitSet.length();
+    }
   }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/OpenBitSetIterator.java b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/OpenBitSetIterator.java
index cd0ce37e..ceadce31 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/OpenBitSetIterator.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/java/org/apache/lucene/util/OpenBitSetIterator.java
@@ -190,4 +190,8 @@ public int docID() {
     return curDocId;
   }
   
+  @Override
+  public long cost() {
+    return words / 64;
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/JustCompileSearch.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/JustCompileSearch.java
index e72b675b..7171cb10 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/JustCompileSearch.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/JustCompileSearch.java
@@ -88,6 +88,11 @@ public int nextDoc() {
     public int advance(int target) {
       throw new UnsupportedOperationException(UNSUPPORTED_MSG);
     }
+    
+    @Override
+    public long cost() {
+      throw new UnsupportedOperationException(UNSUPPORTED_MSG);
+    }
   }
   
   static final class JustCompileExtendedFieldCacheLongParser implements FieldCache.LongParser {
@@ -200,6 +205,10 @@ protected boolean match(int doc) {
       throw new UnsupportedOperationException(UNSUPPORTED_MSG);
     }
     
+    @Override
+    public long cost() {
+      throw new UnsupportedOperationException(UNSUPPORTED_MSG);
+    }
   }
 
   static final class JustCompileQuery extends Query {
@@ -246,6 +255,11 @@ public int nextDoc() {
     public int advance(int target) {
       throw new UnsupportedOperationException(UNSUPPORTED_MSG);
     }
+    
+    @Override
+    public long cost() {
+      throw new UnsupportedOperationException(UNSUPPORTED_MSG);
+    }
   }
   
   static final class JustCompileSimilarity extends Similarity {
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestBooleanScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestBooleanScorer.java
index 89651abd..3eddd774 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestBooleanScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestBooleanScorer.java
@@ -92,6 +92,10 @@ public void testEmptyBucketWithMoreDocs() throws Exception {
         return doc = target <= 3000 ? 3000 : NO_MORE_DOCS;
       }
       
+      @Override
+      public long cost() {
+        return 1;
+      }
     }};
     
     BooleanScorer bs = new BooleanScorer(weight, false, 1, Arrays.asList(scorers), null, scorers.length);
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestCachingCollector.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestCachingCollector.java
index 23216e89..f493d42c 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestCachingCollector.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestCachingCollector.java
@@ -47,6 +47,10 @@ private MockScorer() {
     @Override
     public int advance(int target) throws IOException { return 0; }
     
+    @Override
+    public long cost() {
+      return 1;
+    } 
   }
   
   private static class NoOpCollector extends Collector {
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestDocIdSet.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestDocIdSet.java
index 98fe6fb4..58be63bc 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestDocIdSet.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestDocIdSet.java
@@ -59,6 +59,11 @@ public int advance(int target) {
               while (nextDoc() < target) {}
               return docid;
             }
+            
+            @Override
+            public long cost() {
+              return 1;
+            } 
           };
         } 
       };
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestFilteredQuery.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestFilteredQuery.java
index 741e572d..a114536e 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestFilteredQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestFilteredQuery.java
@@ -536,6 +536,11 @@ public int advance(int target) throws IOException {
                 advanceCalled = true;
                 return termDocsEnum.advance(target);
               }
+              
+              @Override
+              public long cost() {
+                return termDocsEnum.cost();
+              } 
             };
           }
           
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestPositiveScoresOnlyCollector.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestPositiveScoresOnlyCollector.java
index ba92c0fe..1f52b210 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestPositiveScoresOnlyCollector.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestPositiveScoresOnlyCollector.java
@@ -50,6 +50,11 @@ public SimpleScorer(Weight weight) {
       idx = target;
       return idx < scores.length ? idx : NO_MORE_DOCS;
     }
+    
+    @Override
+    public long cost() {
+      return scores.length;
+    } 
   }
 
   // The scores must have positive as well as negative values
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestScoreCachingWrappingScorer.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestScoreCachingWrappingScorer.java
index b1155793..e7ec0f48 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestScoreCachingWrappingScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/TestScoreCachingWrappingScorer.java
@@ -60,6 +60,10 @@ public SimpleScorer(Weight weight) {
       return doc < scores.length ? doc : NO_MORE_DOCS;
     }
     
+    @Override
+    public long cost() {
+      return scores.length;
+    }
   }
   
   private static final class ScoreCachingCollector extends Collector {
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/JustCompileSearchSpans.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/JustCompileSearchSpans.java
index 1442e26d..9a62ad5c 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/JustCompileSearchSpans.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/JustCompileSearchSpans.java
@@ -76,6 +76,10 @@ public boolean isPayloadAvailable() {
       throw new UnsupportedOperationException(UNSUPPORTED_MSG);
     }
     
+    @Override
+    public long cost() {
+      throw new UnsupportedOperationException(UNSUPPORTED_MSG);
+    }
   }
 
   static final class JustCompileSpanQuery extends SpanQuery {
@@ -134,6 +138,11 @@ public int start() {
       throw new UnsupportedOperationException(UNSUPPORTED_MSG);
     }
     
+    @Override
+    public long cost() {
+      throw new UnsupportedOperationException(UNSUPPORTED_MSG);
+    }
+    
   }
   
   static final class JustCompileSpanScorer extends SpanScorer {
diff --git a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/MultiSpansWrapper.java b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/MultiSpansWrapper.java
index 9fba49dd..8308d348 100644
--- a/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/MultiSpansWrapper.java
+++ b/lucene/dev/branches/branch_4x/lucene/core/src/test/org/apache/lucene/search/spans/MultiSpansWrapper.java
@@ -167,4 +167,9 @@ public boolean isPayloadAvailable() throws IOException {
     return current.isPayloadAvailable();
   }
 
+  @Override
+  public long cost() {
+    return Integer.MAX_VALUE; // just for tests
+  }
+
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/DrillSidewaysScorer.java b/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/DrillSidewaysScorer.java
index 47aaee26..8877dbd3 100644
--- a/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/DrillSidewaysScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/DrillSidewaysScorer.java
@@ -614,6 +614,11 @@ public int advance(int target) {
     throw new UnsupportedOperationException();
   }
 
+  @Override
+  public long cost() {
+    return baseScorer.cost();
+  }
+
   @Override
   public Collection<ChildScorer> getChildren() {
     return Collections.singletonList(new ChildScorer(baseScorer, "MUST"));
diff --git a/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/MatchingDocsAsScoredDocIDs.java b/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/MatchingDocsAsScoredDocIDs.java
index 9c2baec0..cf6d4cfd 100644
--- a/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/MatchingDocsAsScoredDocIDs.java
+++ b/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/search/MatchingDocsAsScoredDocIDs.java
@@ -153,6 +153,11 @@ public int docID() {
             return doc + current.context.docBase;
           }
           
+          @Override
+          public long cost() {
+            return size;
+          }
+
           @Override
           public int advance(int target) throws IOException {
             throw new UnsupportedOperationException("not supported");
diff --git a/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/util/ScoredDocIdsUtils.java b/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/util/ScoredDocIdsUtils.java
index c4f35859..0a4a1de0 100644
--- a/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/util/ScoredDocIdsUtils.java
+++ b/lucene/dev/branches/branch_4x/lucene/facet/src/java/org/apache/lucene/facet/util/ScoredDocIdsUtils.java
@@ -162,6 +162,10 @@ public int nextDoc() {
                 return docids[next];
               }
 
+              @Override
+              public long cost() {
+                return size;
+              }
             };
           }
         };
@@ -298,6 +302,10 @@ public int nextDoc() {
               return ++next < maxDoc ? next : NO_MORE_DOCS;
             }
 
+            @Override
+            public long cost() {
+              return maxDoc;
+            }
           };
         }
       };
@@ -394,6 +402,10 @@ public int nextDoc() {
               return next < maxDoc ? next : NO_MORE_DOCS;
             }
 
+            @Override
+            public long cost() {
+              return maxDoc;
+            }
           };
         }
       };
diff --git a/lucene/dev/branches/branch_4x/lucene/grouping/src/java/org/apache/lucene/search/grouping/BlockGroupingCollector.java b/lucene/dev/branches/branch_4x/lucene/grouping/src/java/org/apache/lucene/search/grouping/BlockGroupingCollector.java
index bbfb121e..43a4c91a 100644
--- a/lucene/dev/branches/branch_4x/lucene/grouping/src/java/org/apache/lucene/search/grouping/BlockGroupingCollector.java
+++ b/lucene/dev/branches/branch_4x/lucene/grouping/src/java/org/apache/lucene/search/grouping/BlockGroupingCollector.java
@@ -118,6 +118,11 @@ public int advance(int target) {
     public int nextDoc() {
       throw new UnsupportedOperationException();
     }
+
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 
   private static final class OneGroup {
diff --git a/lucene/dev/branches/branch_4x/lucene/highlighter/src/java/org/apache/lucene/search/postingshighlight/PostingsHighlighter.java b/lucene/dev/branches/branch_4x/lucene/highlighter/src/java/org/apache/lucene/search/postingshighlight/PostingsHighlighter.java
index 2e29778f..69ea296d 100644
--- a/lucene/dev/branches/branch_4x/lucene/highlighter/src/java/org/apache/lucene/search/postingshighlight/PostingsHighlighter.java
+++ b/lucene/dev/branches/branch_4x/lucene/highlighter/src/java/org/apache/lucene/search/postingshighlight/PostingsHighlighter.java
@@ -498,6 +498,9 @@ public int compareTo(OffsetsEnum other) {
 
     @Override
     public int advance(int target) throws IOException { return NO_MORE_DOCS; }
+    
+    @Override
+    public long cost() { return 0; }
   };
   
   /** 
diff --git a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/TermsIncludingScoreQuery.java b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/TermsIncludingScoreQuery.java
index 7be2446f..5d8a8ad3 100644
--- a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/TermsIncludingScoreQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/TermsIncludingScoreQuery.java
@@ -161,17 +161,20 @@ public Scorer scorer(AtomicReaderContext context, boolean scoreDocsInOrder, bool
           return null;
         }
 
+        // what is the runtime...seems ok?
+        final long cost = context.reader().maxDoc() * terms.size();
+
         segmentTermsEnum = terms.iterator(segmentTermsEnum);
         if (scoreDocsInOrder) {
           if (multipleValuesPerDocument) {
-            return new MVInOrderScorer(this, acceptDocs, segmentTermsEnum, context.reader().maxDoc());
+            return new MVInOrderScorer(this, acceptDocs, segmentTermsEnum, context.reader().maxDoc(), cost);
           } else {
-            return new SVInOrderScorer(this, acceptDocs, segmentTermsEnum, context.reader().maxDoc());
+            return new SVInOrderScorer(this, acceptDocs, segmentTermsEnum, context.reader().maxDoc(), cost);
           }
         } else if (multipleValuesPerDocument) {
-          return new MVInnerScorer(this, acceptDocs, segmentTermsEnum, context.reader().maxDoc());
+          return new MVInnerScorer(this, acceptDocs, segmentTermsEnum, context.reader().maxDoc(), cost);
         } else {
-          return new SVInnerScorer(this, acceptDocs, segmentTermsEnum);
+          return new SVInnerScorer(this, acceptDocs, segmentTermsEnum, cost);
         }
       }
     };
@@ -183,16 +186,18 @@ public Scorer scorer(AtomicReaderContext context, boolean scoreDocsInOrder, bool
     final BytesRef spare = new BytesRef();
     final Bits acceptDocs;
     final TermsEnum termsEnum;
+    final long cost;
 
     int upto;
     DocsEnum docsEnum;
     DocsEnum reuse;
     int scoreUpto;
 
-    SVInnerScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum) {
+    SVInnerScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum, long cost) {
       super(weight);
       this.acceptDocs = acceptDocs;
       this.termsEnum = termsEnum;
+      this.cost = cost;
     }
 
     @Override
@@ -261,6 +266,11 @@ private int advanceForExplainOnly(int target) throws IOException {
     public int freq() {
       return 1;
     }
+
+    @Override
+    public long cost() {
+      return cost;
+    }
   }
 
   // This impl that tracks whether a docid has already been emitted. This check makes sure that docs aren't emitted
@@ -270,8 +280,8 @@ public int freq() {
 
     final FixedBitSet alreadyEmittedDocs;
 
-    MVInnerScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum, int maxDoc) {
-      super(weight, acceptDocs, termsEnum);
+    MVInnerScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum, int maxDoc, long cost) {
+      super(weight, acceptDocs, termsEnum, cost);
       alreadyEmittedDocs = new FixedBitSet(maxDoc);
     }
 
@@ -326,15 +336,17 @@ public int nextDoc() throws IOException {
 
     final DocIdSetIterator matchingDocsIterator;
     final float[] scores;
+    final long cost;
 
     int currentDoc = -1;
 
-    SVInOrderScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum, int maxDoc) throws IOException {
+    SVInOrderScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum, int maxDoc, long cost) throws IOException {
       super(weight);
       FixedBitSet matchingDocs = new FixedBitSet(maxDoc);
       this.scores = new float[maxDoc];
       fillDocsAndScores(matchingDocs, acceptDocs, termsEnum);
       this.matchingDocsIterator = matchingDocs.iterator();
+      this.cost = cost;
     }
 
     protected void fillDocsAndScores(FixedBitSet matchingDocs, Bits acceptDocs, TermsEnum termsEnum) throws IOException {
@@ -378,13 +390,18 @@ public int nextDoc() throws IOException {
     public int advance(int target) throws IOException {
       return currentDoc = matchingDocsIterator.advance(target);
     }
+
+    @Override
+    public long cost() {
+      return cost;
+    }
   }
 
   // This scorer deals with the fact that a document can have more than one score from multiple related documents.
   class MVInOrderScorer extends SVInOrderScorer {
 
-    MVInOrderScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum, int maxDoc) throws IOException {
-      super(weight, acceptDocs, termsEnum, maxDoc);
+    MVInOrderScorer(Weight weight, Bits acceptDocs, TermsEnum termsEnum, int maxDoc, long cost) throws IOException {
+      super(weight, acceptDocs, termsEnum, maxDoc, cost);
     }
 
     @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToChildBlockJoinQuery.java b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToChildBlockJoinQuery.java
index 7ca55c18..d04a65a9 100644
--- a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToChildBlockJoinQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToChildBlockJoinQuery.java
@@ -301,6 +301,11 @@ public int advance(int childTarget) throws IOException {
       }
       return childDoc;
     }
+
+    @Override
+    public long cost() {
+      return parentScorer.cost();
+    }
   }
 
   @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinCollector.java b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinCollector.java
index 583eee5b..dc011595 100644
--- a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinCollector.java
+++ b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinCollector.java
@@ -347,6 +347,11 @@ public int advance(int target) {
     public int nextDoc() {
       throw new UnsupportedOperationException();
     }
+
+    @Override
+    public long cost() {
+      return 1;
+    }
   }
 
   private OneGroup[] sortedGroups;
diff --git a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinQuery.java b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinQuery.java
index 1512f455..473dc38f 100644
--- a/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinQuery.java
@@ -410,6 +410,10 @@ public Explanation explain(int docBase) throws IOException {
       );
     }
 
+    @Override
+    public long cost() {
+      return childScorer.cost();
+    }
   }
 
   @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/memory/src/java/org/apache/lucene/index/memory/MemoryIndex.java b/lucene/dev/branches/branch_4x/lucene/memory/src/java/org/apache/lucene/index/memory/MemoryIndex.java
index dd237407..892a6b4f 100644
--- a/lucene/dev/branches/branch_4x/lucene/memory/src/java/org/apache/lucene/index/memory/MemoryIndex.java
+++ b/lucene/dev/branches/branch_4x/lucene/memory/src/java/org/apache/lucene/index/memory/MemoryIndex.java
@@ -1021,6 +1021,11 @@ public int advance(int target) {
       public int freq() throws IOException {
         return freq;
       }
+
+      @Override
+      public long cost() {
+        return 1;
+      }
     }
     
     private class MemoryDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -1101,6 +1106,11 @@ public int endOffset() {
       public BytesRef getPayload() {
         return null;
       }
+      
+      @Override
+      public long cost() {
+        return 1;
+      }
     }
     
     @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/CustomScoreQuery.java b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/CustomScoreQuery.java
index e22b914e..1b9de196 100644
--- a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/CustomScoreQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/CustomScoreQuery.java
@@ -348,6 +348,11 @@ public int advance(int target) throws IOException {
       }
       return doc;
     }
+
+    @Override
+    public long cost() {
+      return subQueryScorer.cost();
+    }
   }
 
   @Override
diff --git a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/BoostedQuery.java b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/BoostedQuery.java
index 8fe1f5a7..7650821e 100644
--- a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/BoostedQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/BoostedQuery.java
@@ -189,6 +189,11 @@ public Explanation explain(int doc) throws IOException {
       res.addDetail(vals.explain(doc));
       return res;
     }
+
+    @Override
+    public long cost() {
+      return scorer.cost();
+    }
   }
 
 
diff --git a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/FunctionQuery.java b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/FunctionQuery.java
index 35d951bb..6c44b05b 100644
--- a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/FunctionQuery.java
+++ b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/FunctionQuery.java
@@ -158,6 +158,11 @@ public float score() throws IOException {
       return score>Float.NEGATIVE_INFINITY ? score : -Float.MAX_VALUE;
     }
 
+    @Override
+    public long cost() {
+      return maxDoc;
+    }
+
     @Override
     public int freq() throws IOException {
       return 1;
diff --git a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/ValueSourceScorer.java b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/ValueSourceScorer.java
index d1b843d4..ec8aced2 100644
--- a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/ValueSourceScorer.java
+++ b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/ValueSourceScorer.java
@@ -91,4 +91,9 @@ public float score() throws IOException {
   public int freq() throws IOException {
     return 1;
   }
+
+  @Override
+  public long cost() {
+    return maxDoc;
+  }
 }
diff --git a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TFValueSource.java b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TFValueSource.java
index f0e4a9c8..0fc4fc99 100644
--- a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TFValueSource.java
+++ b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TFValueSource.java
@@ -97,6 +97,11 @@ public int nextDoc() {
             public int advance(int target) {
               return DocIdSetIterator.NO_MORE_DOCS;
             }
+
+            @Override
+            public long cost() {
+              return 0;
+            }
           };
         }
         atDoc = -1;
diff --git a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TermFreqValueSource.java b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TermFreqValueSource.java
index c2b06542..ee6800cf 100644
--- a/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TermFreqValueSource.java
+++ b/lucene/dev/branches/branch_4x/lucene/queries/src/java/org/apache/lucene/queries/function/valuesource/TermFreqValueSource.java
@@ -90,6 +90,11 @@ public int nextDoc() {
             public int advance(int target) {
               return DocIdSetIterator.NO_MORE_DOCS;
             }
+
+            @Override
+            public long cost() {
+              return 0;
+            }
           };
         }
         atDoc = -1;
diff --git a/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/codecs/ramonly/RAMOnlyPostingsFormat.java b/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/codecs/ramonly/RAMOnlyPostingsFormat.java
index e81dc8e1..b95d7a78 100644
--- a/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/codecs/ramonly/RAMOnlyPostingsFormat.java
+++ b/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/codecs/ramonly/RAMOnlyPostingsFormat.java
@@ -434,6 +434,11 @@ public int freq() throws IOException {
     public int docID() {
       return current.docID;
     }
+    
+    @Override
+    public long cost() {
+      return ramTerm.docs.size();
+    } 
   }
 
   private static class RAMDocsAndPositionsEnum extends DocsAndPositionsEnum {
@@ -506,6 +511,11 @@ public BytesRef getPayload() {
         return null;
       }
     }
+    
+    @Override
+    public long cost() {
+      return ramTerm.docs.size();
+    } 
   }
 
   // Holds all indexes created, keyed by the ID assigned in fieldsConsumer
diff --git a/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/index/BasePostingsFormatTestCase.java b/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/index/BasePostingsFormatTestCase.java
index 8337e432..13c4793f 100644
--- a/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/index/BasePostingsFormatTestCase.java
+++ b/lucene/dev/branches/branch_4x/lucene/test-framework/src/java/org/apache/lucene/index/BasePostingsFormatTestCase.java
@@ -280,6 +280,11 @@ public int advance(int target) {
       }
       return docID;
     }
+    
+    @Override
+    public long cost() {
+      return docFreq;
+    } 
   }
   
   private static class FieldAndTerm {
diff --git a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/schema/LatLonType.java b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/schema/LatLonType.java
index 18a3cfe7..84d0f7d7 100644
--- a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/schema/LatLonType.java
+++ b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/schema/LatLonType.java
@@ -498,6 +498,11 @@ public int freq() throws IOException {
       return 1;
     }
 
+    @Override
+    public long cost() {
+      return maxDoc;
+    }
+
     public Explanation explain(int doc) throws IOException {
       advance(doc);
       boolean matched = this.doc == doc;
diff --git a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/BitDocSet.java b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/BitDocSet.java
index 77c39f50..736cbfeb 100644
--- a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/BitDocSet.java
+++ b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/BitDocSet.java
@@ -294,6 +294,17 @@ public int advance(int target) {
                 pos = bs.nextSetBit(target+base);
                 return adjustedDoc = (pos>=0 && pos<max) ? pos-base : NO_MORE_DOCS;
               }
+
+              @Override
+              public long cost() {
+                // we don't want to actually compute cardinality, but
+                // if its already been computed, we use it
+                if (size != -1) {
+                  return size;
+                } else {
+                  return bs.capacity();
+                }
+              }
             };
           }
 
diff --git a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/DocSetBase.java b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/DocSetBase.java
index 8cc014bd..dd31c128 100644
--- a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/DocSetBase.java
+++ b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/DocSetBase.java
@@ -186,6 +186,11 @@ public int advance(int target) {
                 pos = bs.nextSetBit(target+base);
                 return adjustedDoc = (pos>=0 && pos<max) ? pos-base : NO_MORE_DOCS;
               }
+
+              @Override
+              public long cost() {
+                return bs.capacity();
+              }
             };
           }
 
diff --git a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/JoinQParserPlugin.java b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/JoinQParserPlugin.java
index ba50657c..ae35bb27 100644
--- a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/JoinQParserPlugin.java
+++ b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/JoinQParserPlugin.java
@@ -546,6 +546,11 @@ public int freq() throws IOException {
     public int advance(int target) throws IOException {
       return iter.advance(target);
     }
+
+    @Override
+    public long cost() {
+      return iter.cost();
+    }
   }
 
 
diff --git a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrConstantScoreQuery.java b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrConstantScoreQuery.java
index c0815747..4ce84444 100644
--- a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrConstantScoreQuery.java
+++ b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrConstantScoreQuery.java
@@ -196,6 +196,11 @@ public int freq() throws IOException {
     public int advance(int target) throws IOException {
       return docIdSetIterator.advance(target);
     }
+
+    @Override
+    public long cost() {
+      return docIdSetIterator.cost();
+    }
   }
 
   @Override
diff --git a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java
index b2514713..c1149e16 100644
--- a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java
+++ b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java
@@ -2307,6 +2307,11 @@ public int nextDoc() throws IOException {
     public int advance(int target) throws IOException {
       return doNext(first.advance(target));
     }
+
+    @Override
+    public long cost() {
+      return first.cost();
+    }
   }
 
   private static class DualFilterIterator extends DocIdSetIterator {
@@ -2344,6 +2349,11 @@ public int advance(int target) throws IOException {
         if (other == doc) return doc;
       }
     }
+
+    @Override
+    public long cost() {
+      return Math.min(a.cost(), b.cost());
+    }
   }
 
 }
diff --git a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SortedIntDocSet.java b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SortedIntDocSet.java
index 1ce81bd9..40f544dc 100644
--- a/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SortedIntDocSet.java
+++ b/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/search/SortedIntDocSet.java
@@ -755,6 +755,10 @@ else if (rawDoc > target) {
                 }
               }
 
+              @Override
+              public long cost() {
+                return docs.length;
+              }
             };
           }
 
