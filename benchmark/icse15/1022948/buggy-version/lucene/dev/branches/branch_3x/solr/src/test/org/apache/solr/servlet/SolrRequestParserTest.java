  Merged /lucene/dev/trunk/lucene/build.xml:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/icu/lib:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/icu/src/java/org/apache/lucene/collation/ICUCollationKeyAnalyzer.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/icu/src/java/org/apache/lucene/collation/ICUCollationKeyFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/icu:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/CHANGES.txt:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/instantiated/src/test/org/apache/lucene/store/instantiated/TestIndicesEquals.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/highlighter/src/test:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/highlighter:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/smartcn:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/test/org/apache/lucene/analysis/shingle:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/test/org/apache/lucene/analysis/snowball/TestSnowball.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/test:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/hu/HungarianLightStemmer.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/hy/ArmenianAnalyzer.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/ca/CatalanAnalyzer.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/shingle:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/en/EnglishMinimalStemmer.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/en/EnglishPossessiveFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/eu/BasqueAnalyzer.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/apache/lucene/analysis/util/StemmerUtil.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common/src/java/org/tartarus/snowball/TestApp.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/common:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/stempel/src/java/org/apache/lucene/analysis/pl/PolishAnalyzer.java:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers/stempel:r1022939
  Merged /lucene/dev/trunk/lucene/contrib/analyzers:r1022939
  Merged /lucene/dev/trunk/lucene/contrib:r1022939
  Merged /lucene/dev/trunk/lucene/backwards/src/test/org/apache/lucene/analysis/TestISOLatin1AccentFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/backwards/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java:r1022939
  Merged /lucene/dev/trunk/lucene/backwards/src/test/org/apache/lucene/util/TestAttributeSource.java:r1022939
  Merged /lucene/dev/trunk/lucene/backwards/src/test/org/apache/lucene/document/TestDateTools.java:r1022939
  Merged /lucene/dev/trunk/lucene/backwards/src/test/org/apache/lucene/document/TestNumberTools.java:r1022939
  Merged /lucene/dev/trunk/lucene/backwards/src:r1022939
  Merged /lucene/dev/trunk/lucene/CHANGES.txt:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/util/TestAttributeSource.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/document/TestNumberTools.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/document/TestDateTools.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis/random.text.with.email.addresses.txt:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis/urls.from.random.text.with.urls.txt:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis/LuceneResourcesWikiPage.html:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis/email.addresses.from.random.text.with.email.addresses.txt:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis/TestISOLatin1AccentFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis/LuceneResourcesWikiPageURLs.txt:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis/random.text.with.urls.txt:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/analysis:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/collation:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/search/TestCachingWrapperFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/search/spans/TestPayloadSpans.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/search/spans/TestSpans.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/test/org/apache/lucene/index:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/search/MultiTermQueryWrapperFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/BaseCharFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/standard/ClassicTokenizerImpl.jflex:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/standard/UAX29Tokenizer.jflex:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/standard/StandardTokenizer.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/standard/StandardTokenizerImpl.jflex:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/standard/StandardFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/standard:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/Tokenizer.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/LowerCaseTokenizer.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/LengthFilter.java:r1022939
  Merged /lucene/dev/trunk/lucene/src/java/org/apache/lucene/analysis/LetterTokenizer.java:r1022939
  Merged /lucene/dev/trunk/lucene/src:r1022939
  Merged /lucene/dev/trunk/lucene:r1022939
  Merged /lucene/dev/trunk/solr/lib/commons-httpclient-3.1.jar:r1022939
  Merged /lucene/dev/trunk/solr/lib/jcl-over-slf4j-1.5.5.jar:r1022939
  Merged /lucene/dev/trunk/solr/src/webapp/src/org/apache/solr/client/solrj/embedded:r1022939
  Merged /lucene/dev/trunk/solr/src/webapp/web/admin:r1022939
  Merged /lucene/dev/trunk/solr/src/test/org/apache/solr/client:r1022939
  Merged /lucene/dev/trunk/solr/src/test/org/apache/solr/update/AutoCommitTest.java:r1022939
  Merged /lucene/dev/trunk/solr/src/test/org/apache/solr/analysis/TestPatternTokenizerFactory.java:r1022939
  Merged /lucene/dev/trunk/solr/src/test/org/apache/solr/analysis/TestTrimFilter.java:r1022939
  Merged /lucene/dev/trunk/solr/src/test/org/apache/solr/analysis/TestSynonymFilter.java:r1022939
  Merged /lucene/dev/trunk/solr/src/test/org/apache/solr/analysis/TestShingleFilterFactory.java:r1022939
  Merged /lucene/dev/trunk/solr/src/test/org/apache/solr/analysis/TestRemoveDuplicatesTokenFilter.java:r1022939
/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.solr.servlet;

import static org.easymock.EasyMock.createMock;
import static org.easymock.EasyMock.expect;
import static org.easymock.EasyMock.replay;

import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import org.apache.commons.io.IOUtils;
import org.apache.solr.SolrTestCaseJ4;
import org.apache.solr.common.params.CommonParams;
import org.apache.solr.common.params.MultiMapSolrParams;
import org.apache.solr.common.params.SolrParams;
import org.apache.solr.common.util.ContentStream;
import org.apache.solr.core.SolrCore;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;

import static org.junit.Assert.*;

public class SolrRequestParserTest extends SolrTestCaseJ4 {

  @BeforeClass
  public static void beforeClass() throws Exception {
    initCore("solrconfig.xml", "schema.xml");
    parser = new SolrRequestParsers( h.getCore().getSolrConfig() );
  }
  
  static SolrRequestParsers parser;

  @AfterClass
  public static void afterClass() throws Exception {
    parser = null;
  }
  
  @Test
  public void testStreamBody() throws Exception
  {
    String body1 = "AMANAPLANPANAMA";
    String body2 = "qwertasdfgzxcvb";
    String body3 = "1234567890";
    
    SolrCore core = h.getCore();
    
    Map<String,String[]> args = new HashMap<String, String[]>();
    args.put( CommonParams.STREAM_BODY, new String[] {body1} );
    
    // Make sure it got a single stream in and out ok
    List<ContentStream> streams = new ArrayList<ContentStream>();
    parser.buildRequestFrom( core, new MultiMapSolrParams( args ), streams );
    assertEquals( 1, streams.size() );
    assertEquals( body1, IOUtils.toString( streams.get(0).getStream() ) );
    
    // Now add three and make sure they come out ok
    streams = new ArrayList<ContentStream>();
    args.put( CommonParams.STREAM_BODY, new String[] {body1,body2,body3} );
    parser.buildRequestFrom( core, new MultiMapSolrParams( args ), streams );
    assertEquals( 3, streams.size() );
    ArrayList<String> input  = new ArrayList<String>();
    ArrayList<String> output = new ArrayList<String>();
    input.add( body1 );
    input.add( body2 );
    input.add( body3 );
    output.add( IOUtils.toString( streams.get(0).getStream() ) );
    output.add( IOUtils.toString( streams.get(1).getStream() ) );
    output.add( IOUtils.toString( streams.get(2).getStream() ) );
    // sort them so the output is consistent
    Collections.sort( input );
    Collections.sort( output );
    assertEquals( input.toString(), output.toString() );
    
    // set the contentType and make sure tat gets set
    String ctype = "text/xxx";
    streams = new ArrayList<ContentStream>();
    args.put( CommonParams.STREAM_CONTENTTYPE, new String[] {ctype} );
    parser.buildRequestFrom( core, new MultiMapSolrParams( args ), streams );
    for( ContentStream s : streams ) {
      assertEquals( ctype, s.getContentType() );
    }
  }
  
  @Test
  public void testStreamURL() throws Exception
  {
    boolean ok = false;
    String url = "http://www.apache.org/dist/lucene/solr/";
    String txt = null;
    try {
      URLConnection connection = new URL(url).openConnection();
      connection.setConnectTimeout(5000);
      connection.setReadTimeout(5000);
      connection.connect();
      txt = IOUtils.toString( connection.getInputStream());
    }
    catch( Exception ex ) {
      // TODO - should it fail/skip?
      fail( "this test only works if you have a network connection." );
      return;
    }

    SolrCore core = h.getCore();
    
    Map<String,String[]> args = new HashMap<String, String[]>();
    args.put( CommonParams.STREAM_URL, new String[] {url} );
    
    // Make sure it got a single stream in and out ok
    List<ContentStream> streams = new ArrayList<ContentStream>();
    parser.buildRequestFrom( core, new MultiMapSolrParams( args ), streams );
    assertEquals( 1, streams.size() );
    assertEquals( txt, IOUtils.toString( streams.get(0).getStream() ) );
  }
  
  @Test
  public void testUrlParamParsing()
  {
    String[][] teststr = new String[][] {
      { "this is simple", "this%20is%20simple" },
      { "this is simple", "this+is+simple" },
      { "\u00FC", "%C3%BC" },   // lower-case "u" with diaeresis/umlaut
      { "\u0026", "%26" },      // &
      { "\u20AC", "%E2%82%AC" } // euro
    };
    
    for( String[] tst : teststr ) {
      MultiMapSolrParams params = SolrRequestParsers.parseQueryString( "val="+tst[1] );
      assertEquals( tst[0], params.get( "val" ) );
    }
  }
  
  @Test
  public void testStandardParseParamsAndFillStreams() throws Exception
  {
    ArrayList<ContentStream> streams = new ArrayList<ContentStream>();
    Map<String,String[]> params = new HashMap<String, String[]>();
    params.put( "q", new String[] { "hello" } );
    
    // Set up the expected behavior
    String[] ct = new String[] {
        "application/x-www-form-urlencoded",
        "Application/x-www-form-urlencoded",
        "application/x-www-form-urlencoded; charset=utf-8",
        "application/x-www-form-urlencoded;"
    };
    
    for( String contentType : ct ) {
      HttpServletRequest request = createMock(HttpServletRequest.class);
      expect(request.getMethod()).andReturn("POST").anyTimes();
      expect(request.getContentType()).andReturn( contentType ).anyTimes();
      expect(request.getParameterMap()).andReturn(params).anyTimes();
      replay(request);
      
      MultipartRequestParser multipart = new MultipartRequestParser( 1000000 );
      RawRequestParser raw = new RawRequestParser();
      StandardRequestParser standard = new StandardRequestParser( multipart, raw );
      
      SolrParams p = standard.parseParamsAndFillStreams( request, streams );
      
      assertEquals( "contentType: "+contentType, "hello", p.get("q") );
    }
  }
}
