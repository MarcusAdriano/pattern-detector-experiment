  Merged /lucene/dev/branches/lucene2510/lucene/replicator:r1364862-1365496
  Merged /lucene/dev/branches/lucene3312/lucene/replicator:r1357905-1379945
  Merged /lucene/dev/branches/pforcodec_3892/lucene/replicator:r1352188-1375470
  Merged /lucene/dev/branches/lucene4055/lucene/replicator:r1338960-1343359
  Merged /lucene/dev/branches/ghost_of_4456/lucene/replicator:r1394211-1394305
  Merged /lucene/dev/branches/lucene4446/lucene/replicator:r1397400-1398082
  Merged /lucene/dev/branches/lucene4547/lucene/replicator:r1407149-1443597
  Merged /lucene/dev/branches/solr3733/lucene/replicator:r1388080-1388269
  Merged /lucene/dev/branches/lucene3846/lucene/replicator:r1397170-1403761
  Merged /lucene/dev/branches/lucene4765/lucene/replicator:r1444646-1447981
  Merged /lucene/dev/branches/lucene4199/lucene/replicator:r1358548-1359191
  Merged /lucene/dev/branches/slowclosing/lucene/replicator:r1393532-1393785
  Merged /lucene/dev/branches/lucene3969/lucene/replicator:r1311219-1324948
  Merged /lucene/dev/branches/branch_3x/lucene/replicator:r1232954,1302749,1302808,1303007,1303023,1303269,1303733,1303854,1304295,1304360,1304660,1304904,1305074,1305142,1305681,1305693,1305719,1305741,1305816,1305837,1306929,1307050
  Merged /lucene/dev/branches/branch_4x/lucene/replicator:r1344391,1344929,1348012,1348274,1348293,1348919,1348951,1349048,1349340,1349446,1349991,1353701,1355203,1356608,1359358,1363876,1364063,1364069,1367391,1367489,1367833,1368975,1369226,1371960,1374622,1375497,1375558,1376547,1378442,1378591,1379175,1380802,1381204,1383216,1386921,1388425,1389811,1389929,1392460,1393832,1394309,1395515,1404227,1405891,1416280,1423718,1428127,1433410,1436764,1449183,1451201,1453934,1457458,1457855,1459440,1460858,1464431,1465370,1467413,1468638,1468650,1469958,1470052,1476857,1477348,1477560,1477569,1478728,1480024,1481936,1484887
  Merged /lucene/dev/branches/lucene_solr_4_0/lucene/replicator:r1388937,1389448,1390046,1394306
  Merged /lucene/dev/branches/lucene_solr_4_1/lucene/replicator:r1434545
  Merged /lucene/dev/branches/lucene_solr_4_3/lucene/replicator:r1470051
  Merged /lucene/dev/branches/cleanup2878/lucene/replicator:r1403701-1403781
  Merged /lucene/dev/branches/lucene_solr_3_6/lucene/replicator:r1423711
  Merged /lucene/dev/branches/branch_4x/lucene/site:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/licenses:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/memory:r1484887
  Merged /lucene/dev/branches/lucene4446/lucene/JRE_VERSION_MIGRATION.txt:r1397400-1398082
  Merged /lucene/dev/branches/solr3733/lucene/JRE_VERSION_MIGRATION.txt:r1388080-1388269
  Merged /lucene/dev/branches/lucene4547/lucene/JRE_VERSION_MIGRATION.txt:r1407149-1443597
  Merged /lucene/dev/branches/lucene3846/lucene/JRE_VERSION_MIGRATION.txt:r1397170-1403761
  Merged /lucene/dev/branches/lucene4765/lucene/JRE_VERSION_MIGRATION.txt:r1444646-1447981
  Merged /lucene/dev/branches/lucene4199/lucene/JRE_VERSION_MIGRATION.txt:r1358548-1359191
  Merged /lucene/dev/branches/slowclosing/lucene/JRE_VERSION_MIGRATION.txt:r1393532-1393785
  Merged /lucene/dev/branches/lucene3969/lucene/JRE_VERSION_MIGRATION.txt:r1311219-1324948
  Merged /lucene/dev/branches/branch_3x/lucene/JRE_VERSION_MIGRATION.txt:r1232954,1302749,1302808,1303007,1303023,1303269,1303733,1303854,1304295,1304360,1304660,1304904,1305074,1305142,1305681,1305693,1305719,1305741,1305816,1305837,1306929,1307050
  Merged /lucene/dev/branches/branch_4x/lucene/JRE_VERSION_MIGRATION.txt:r1344391,1344929,1348012,1348274,1348293,1348919,1348951,1349048,1349340,1349446,1349991,1353701,1355203,1356608,1359358,1363876,1364063,1364069,1367391,1367489,1367833,1368975,1369226,1371960,1374622,1375497,1375558,1376547,1378442,1378591,1379175,1380802,1381204,1383216,1386921,1388425,1389811,1389929,1392460,1393832,1394309,1395515,1404227,1405891,1416280,1423718,1428127,1433410,1436764,1449183,1451201,1453934,1457458,1457855,1459440,1460858,1464431,1465370,1467413,1468638,1468650,1469958,1470052,1476857,1477348,1477560,1477569,1478728,1480024,1481936,1484887
  Merged /lucene/dev/branches/lucene_solr_4_0/lucene/JRE_VERSION_MIGRATION.txt:r1388937,1389448,1390046,1394306
  Merged /lucene/dev/branches/lucene_solr_4_1/lucene/JRE_VERSION_MIGRATION.txt:r1434545
  Merged /lucene/dev/branches/lucene_solr_4_3/lucene/JRE_VERSION_MIGRATION.txt:r1470051
  Merged /lucene/dev/branches/cleanup2878/lucene/JRE_VERSION_MIGRATION.txt:r1403701-1403781
  Merged /lucene/dev/branches/lucene_solr_3_6/lucene/JRE_VERSION_MIGRATION.txt:r1423711
  Merged /lucene/dev/branches/lucene2510/lucene/JRE_VERSION_MIGRATION.txt:r1364862-1365496
  Merged /lucene/dev/branches/lucene3312/lucene/JRE_VERSION_MIGRATION.txt:r1357905-1379945
  Merged /lucene/dev/branches/pforcodec_3892/lucene/JRE_VERSION_MIGRATION.txt:r1352188-1375470
  Merged /lucene/dev/branches/lucene4055/lucene/JRE_VERSION_MIGRATION.txt:r1338960-1343359
  Merged /lucene/dev/branches/ghost_of_4456/lucene/JRE_VERSION_MIGRATION.txt:r1394211-1394305
  Merged /lucene/dev/branches/branch_4x/lucene/BUILD.txt:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/suggest:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/analysis/common:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/analysis:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/CHANGES.txt:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/grouping:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/misc:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/classification:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/sandbox:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/highlighter:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/NOTICE.txt:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/LICENSE.txt:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/codecs:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/ivy-settings.xml:r1484887
  Merged /lucene/dev/branches/slowclosing/lucene/SYSTEM_REQUIREMENTS.txt:r1393532-1393785
  Merged /lucene/dev/branches/lucene3969/lucene/SYSTEM_REQUIREMENTS.txt:r1311219-1324948
  Merged /lucene/dev/branches/branch_3x/lucene/SYSTEM_REQUIREMENTS.txt:r1232954,1302749,1302808,1303007,1303023,1303269,1303733,1303854,1304295,1304360,1304660,1304904,1305074,1305142,1305681,1305693,1305719,1305741,1305816,1305837,1306929,1307050
  Merged /lucene/dev/branches/branch_4x/lucene/SYSTEM_REQUIREMENTS.txt:r1344391,1344929,1348012,1348274,1348293,1348919,1348951,1349048,1349340,1349446,1349991,1353701,1355203,1356608,1359358,1363876,1364063,1364069,1367391,1367489,1367833,1368975,1369226,1371960,1374622,1375497,1375558,1376547,1378442,1378591,1379175,1380802,1381204,1383216,1386921,1388425,1389811,1389929,1392460,1393832,1394309,1395515,1404227,1405891,1416280,1423718,1428127,1433410,1436764,1449183,1451201,1453934,1457458,1457855,1459440,1460858,1464431,1465370,1467413,1468638,1468650,1469958,1470052,1476857,1477348,1477560,1477569,1478728,1480024,1481936,1484887
  Merged /lucene/dev/branches/lucene_solr_4_0/lucene/SYSTEM_REQUIREMENTS.txt:r1388937,1389448,1390046,1394306
  Merged /lucene/dev/branches/lucene_solr_4_1/lucene/SYSTEM_REQUIREMENTS.txt:r1434545
  Merged /lucene/dev/branches/lucene_solr_4_3/lucene/SYSTEM_REQUIREMENTS.txt:r1470051
  Merged /lucene/dev/branches/cleanup2878/lucene/SYSTEM_REQUIREMENTS.txt:r1403701-1403781
  Merged /lucene/dev/branches/lucene_solr_3_6/lucene/SYSTEM_REQUIREMENTS.txt:r1423711
  Merged /lucene/dev/branches/lucene2510/lucene/SYSTEM_REQUIREMENTS.txt:r1364862-1365496
  Merged /lucene/dev/branches/lucene3312/lucene/SYSTEM_REQUIREMENTS.txt:r1357905-1379945
  Merged /lucene/dev/branches/pforcodec_3892/lucene/SYSTEM_REQUIREMENTS.txt:r1352188-1375470
  Merged /lucene/dev/branches/lucene4055/lucene/SYSTEM_REQUIREMENTS.txt:r1338960-1343359
  Merged /lucene/dev/branches/ghost_of_4456/lucene/SYSTEM_REQUIREMENTS.txt:r1394211-1394305
  Merged /lucene/dev/branches/lucene4446/lucene/SYSTEM_REQUIREMENTS.txt:r1397400-1398082
  Merged /lucene/dev/branches/solr3733/lucene/SYSTEM_REQUIREMENTS.txt:r1388080-1388269
  Merged /lucene/dev/branches/lucene4547/lucene/SYSTEM_REQUIREMENTS.txt:r1407149-1443597
  Merged /lucene/dev/branches/lucene3846/lucene/SYSTEM_REQUIREMENTS.txt:r1397170-1403761
  Merged /lucene/dev/branches/lucene4765/lucene/SYSTEM_REQUIREMENTS.txt:r1444646-1447981
  Merged /lucene/dev/branches/lucene4199/lucene/SYSTEM_REQUIREMENTS.txt:r1358548-1359191
  Merged /lucene/dev/branches/branch_4x/lucene/MIGRATE.txt:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/test-framework:r1484887
  Merged /lucene/dev/branches/lucene_solr_4_3/lucene/README.txt:r1470051
  Merged /lucene/dev/branches/cleanup2878/lucene/README.txt:r1403701-1403781
  Merged /lucene/dev/branches/lucene_solr_3_6/lucene/README.txt:r1423711
  Merged /lucene/dev/branches/lucene2510/lucene/README.txt:r1364862-1365496
  Merged /lucene/dev/branches/lucene3312/lucene/README.txt:r1357905-1379945
  Merged /lucene/dev/branches/lucene4055/lucene/README.txt:r1338960-1343359
  Merged /lucene/dev/branches/pforcodec_3892/lucene/README.txt:r1352188-1375470
  Merged /lucene/dev/branches/ghost_of_4456/lucene/README.txt:r1394211-1394305
  Merged /lucene/dev/branches/lucene4446/lucene/README.txt:r1397400-1398082
  Merged /lucene/dev/branches/solr3733/lucene/README.txt:r1388080-1388269
  Merged /lucene/dev/branches/lucene4547/lucene/README.txt:r1407149-1443597
  Merged /lucene/dev/branches/lucene3846/lucene/README.txt:r1397170-1403761
  Merged /lucene/dev/branches/lucene4765/lucene/README.txt:r1444646-1447981
  Merged /lucene/dev/branches/lucene4199/lucene/README.txt:r1358548-1359191
  Merged /lucene/dev/branches/slowclosing/lucene/README.txt:r1393532-1393785
  Merged /lucene/dev/branches/lucene3969/lucene/README.txt:r1311219-1324948
  Merged /lucene/dev/branches/branch_3x/lucene/README.txt:r1232954,1302749,1302808,1303007,1303023,1303269,1303733,1303854,1304295,1304360,1304660,1304904,1305074,1305142,1305681,1305693,1305719,1305741,1305816,1305837,1306929,1307050
  Merged /lucene/dev/branches/branch_4x/lucene/README.txt:r1344391,1344929,1348012,1348274,1348293,1348919,1348951,1349048,1349340,1349446,1349991,1353701,1355203,1356608,1359358,1363876,1364063,1364069,1367391,1367489,1367833,1368975,1369226,1371960,1374622,1375497,1375558,1376547,1378442,1378591,1379175,1380802,1381204,1383216,1386921,1388425,1389811,1389929,1392460,1393832,1394309,1395515,1404227,1405891,1416280,1423718,1428127,1433410,1436764,1449183,1451201,1453934,1457458,1457855,1459440,1460858,1464431,1465370,1467413,1468638,1468650,1469958,1470052,1476857,1477348,1477560,1477569,1478728,1480024,1481936,1484887
  Merged /lucene/dev/branches/lucene_solr_4_0/lucene/README.txt:r1388937,1389448,1390046,1394306
  Merged /lucene/dev/branches/lucene_solr_4_1/lucene/README.txt:r1434545
  Merged /lucene/dev/branches/branch_4x/lucene/queries:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/module-build.xml:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/facet:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/queryparser:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/common-build.xml:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/demo:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/core:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/benchmark:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/spatial:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/build.xml:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/join:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/tools:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene/backwards:r1484887
  Merged /lucene/dev/branches/branch_4x/lucene:r1484887
  Merged /lucene/dev/branches/branch_4x/dev-tools:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/build.xml:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/NOTICE.txt:r1484887
  Merged /lucene/dev/branches/lucene3795_lsp_spatial_module/solr/LICENSE.txt:r1291491-1300396
  Merged /lucene/dev/branches/preflexfixes/solr/LICENSE.txt:r967125-979432
  Merged /lucene/dev/branches/branch_3x/solr/LICENSE.txt:r949730,961612,979161,980654,982195,987811,988512,1025544,1026614,1034080,1039151,1050654,1056762,1060014,1060438,1060784,1061035,1063880,1063934,1065324,1070818,1075044,1079376,1079381,1080071,1081052,1083240,1085811,1090423,1091501,1092373,1095519,1098770,1099210,1100407,1100480,1100494,1100515,1101106,1103086,1128215,1128227,1128462,1129419,1129435,1130612,1132581,1132978,1134823,1134917,1136714,1138351,1139430,1139461,1141060,1144653,1148611,1148849,1148864,1150434,1151830,1151947,1152766,1166791,1171384,1173311,1173701,1173745,1177994,1184955,1188805,1189914,1189969,1198337,1199847,1204494,1204519,1204547,1204565,1204826,1207010,1208375,1226235,1229268,1230429,1232954,1234450,1235713,1244960,1302703,1302733,1302749,1302808,1303269,1303733,1304295,1304360,1304660,1304904,1305074,1305574,1305585,1305622,1305681,1305693,1305741,1306929,1310314
  Merged /lucene/dev/branches/branch_4x/solr/LICENSE.txt:r1349991,1359358,1367833,1368975,1369231,1378442,1390137,1449183,1467413,1468482,1468511,1468522,1468638,1476857,1478854,1484887
  Merged /lucene/dev/branches/lucene_solr_3_1/solr/LICENSE.txt:r1081856,1083239,1085499,1085511,1085532,1085809,1101103
  Merged /lucene/dev/branches/lucene_solr_4_0/solr/LICENSE.txt:r1388937,1389448,1390046,1390136
  Merged /lucene/solr/branches/newtrunk/solr/LICENSE.txt:r924462
  Merged /lucene/dev/branches/lucene_solr_3_3/solr/LICENSE.txt:r1138390,1138979,1139775
  Merged /lucene/java/branches/lucene_3_0/solr/LICENSE.txt:r880793,896906
  Merged /lucene/dev/branches/bulkpostings/solr/LICENSE.txt:r1069647,1069925
  Merged /lucene/java/branches/lucene_2_9/solr/LICENSE.txt:r817269-818600,825998,829134,829881,831036,896850,909334
  Merged /lucene/dev/branches/realtime_search/solr/LICENSE.txt:r953476-1097796
  Merged /lucene/dev/branches/lucene3622/solr/LICENSE.txt:r1211241-1213825
  Merged /lucene/dev/branches/lucene3606/solr/LICENSE.txt:r1209906-1212022
  Merged /lucene/java/branches/lucene_2_9_back_compat_tests/solr/LICENSE.txt:r818601-821336
  Merged /lucene/dev/branches/solr2452/solr/LICENSE.txt:r1087601-1144716
  Merged /lucene/dev/branches/lucene4446/solr/LICENSE.txt:r1397400-1398082
  Merged /lucene/dev/branches/solr3733/solr/LICENSE.txt:r1388080-1388269
  Merged /lucene/dev/branches/lucene4547/solr/LICENSE.txt:r1407149-1443597
  Merged /lucene/dev/branches/LUCENE2793/solr/LICENSE.txt:r1137551-1144189
  Merged /lucene/dev/branches/lucene3846/solr/LICENSE.txt:r1397170-1403761
  Merged /lucene/solr/trunk/LICENSE.txt:r922950-923910,923912-925091
  Merged /lucene/dev/branches/lucene4765/solr/LICENSE.txt:r1444646-1447981
  Merged /lucene/dev/branches/lucene4199/solr/LICENSE.txt:r1358548-1359191
  Merged /lucene/dev/branches/lucene2858/solr/LICENSE.txt:r1234440-1238051
  Merged /lucene/dev/branches/lucene3969/solr/LICENSE.txt:r1311219-1324948
  Merged /lucene/dev/branches/lucene_solr_4_1/solr/LICENSE.txt:r1434389
  Merged /lucene/dev/branches/lucene_solr_3_2/solr/LICENSE.txt:r1128223,1128247,1129418,1129472
  Merged /lucene/dev/branches/cleanup2878/solr/LICENSE.txt:r1403701-1403781
  Merged /lucene/java/branches/lucene_2_4/solr/LICENSE.txt:r748824
  Merged /lucene/dev/branches/lucene2510/solr/LICENSE.txt:r1364862-1365496
  Merged /lucene/dev/branches/lucene3312/solr/LICENSE.txt:r1357905-1379945
  Merged /lucene/dev/branches/docvalues/solr/LICENSE.txt:r1021634-1134288
  Merged /lucene/dev/branches/lucene2621/solr/LICENSE.txt:r1188713-1197598,1197605-1199706,1199787-1202835
  Merged /lucene/dev/branches/pforcodec_3892/solr/LICENSE.txt:r1352188-1375470
  Merged /lucene/dev/branches/lucene4055/solr/LICENSE.txt:r1338960-1343359
  Merged /lucene/dev/branches/lucene3661/solr/LICENSE.txt:r1233476-1237242,1237250-1238012
  Merged /lucene/dev/branches/branch_4x/solr/contrib/velocity/src/test-files/velocity/solr/collection1/conf/velocity/numFound.vm:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/contrib:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/site:r1484887
  Merged /lucene/dev/branches/lucene_solr_3_2/solr/SYSTEM_REQUIREMENTS.txt:r1128223,1128247,1129418,1129472
  Merged /lucene/dev/branches/lucene_solr_4_1/solr/SYSTEM_REQUIREMENTS.txt:r1434389
  Merged /lucene/dev/branches/cleanup2878/solr/SYSTEM_REQUIREMENTS.txt:r1403701-1403781
  Merged /lucene/java/branches/lucene_2_4/solr/SYSTEM_REQUIREMENTS.txt:r748824
  Merged /lucene/dev/branches/lucene2510/solr/SYSTEM_REQUIREMENTS.txt:r1364862-1365496
  Merged /lucene/dev/branches/lucene3312/solr/SYSTEM_REQUIREMENTS.txt:r1357905-1379945
  Merged /lucene/dev/branches/docvalues/solr/SYSTEM_REQUIREMENTS.txt:r1021634-1134288
  Merged /lucene/dev/branches/lucene2621/solr/SYSTEM_REQUIREMENTS.txt:r1188713-1197598,1197605-1199706,1199787-1202835
  Merged /lucene/dev/branches/lucene4055/solr/SYSTEM_REQUIREMENTS.txt:r1338960-1343359
  Merged /lucene/dev/branches/pforcodec_3892/solr/SYSTEM_REQUIREMENTS.txt:r1352188-1375470
  Merged /lucene/dev/branches/lucene3661/solr/SYSTEM_REQUIREMENTS.txt:r1233476-1237242,1237250-1238012
  Merged /lucene/dev/branches/lucene3795_lsp_spatial_module/solr/SYSTEM_REQUIREMENTS.txt:r1291491-1300396
  Merged /lucene/dev/branches/preflexfixes/solr/SYSTEM_REQUIREMENTS.txt:r967125-979432
  Merged /lucene/dev/branches/branch_3x/solr/SYSTEM_REQUIREMENTS.txt:r949730,961612,979161,980654,982195,987811,988512,1025544,1026614,1034080,1039151,1050654,1056762,1060014,1060438,1060784,1061035,1063880,1063934,1065324,1070818,1075044,1079376,1079381,1080071,1081052,1083240,1085811,1090423,1091501,1092373,1095519,1098770,1099210,1100407,1100480,1100494,1100515,1101106,1103086,1128215,1128227,1128462,1129419,1129435,1130612,1132581,1132978,1134823,1134917,1136714,1138351,1139430,1139461,1141060,1144653,1148611,1148849,1148864,1150434,1151830,1151947,1152766,1166791,1171384,1173311,1173701,1173745,1177994,1184955,1188805,1189914,1189969,1198337,1199847,1204494,1204519,1204547,1204565,1204826,1207010,1208375,1226235,1229268,1230429,1232954,1234450,1235713,1244960,1302703,1302733,1302749,1302808,1303269,1303733,1304295,1304360,1304660,1304904,1305074,1305574,1305585,1305622,1305681,1305693,1305741,1306929,1310314
  Merged /lucene/dev/branches/branch_4x/solr/SYSTEM_REQUIREMENTS.txt:r1349991,1359358,1367833,1368975,1369231,1378442,1390137,1449183,1467413,1468482,1468511,1468522,1468638,1476857,1478854,1484887
  Merged /lucene/dev/branches/lucene_solr_4_0/solr/SYSTEM_REQUIREMENTS.txt:r1388937,1389448,1390046,1390136
  Merged /lucene/dev/branches/lucene_solr_3_1/solr/SYSTEM_REQUIREMENTS.txt:r1081856,1083239,1085499,1085511,1085532,1085809,1101103
  Merged /lucene/dev/branches/lucene_solr_3_3/solr/SYSTEM_REQUIREMENTS.txt:r1138390,1138979,1139775
  Merged /lucene/solr/branches/newtrunk/solr/SYSTEM_REQUIREMENTS.txt:r924462
  Merged /lucene/java/branches/lucene_3_0/solr/SYSTEM_REQUIREMENTS.txt:r880793,896906
  Merged /lucene/dev/branches/bulkpostings/solr/SYSTEM_REQUIREMENTS.txt:r1069647,1069925
  Merged /lucene/dev/branches/realtime_search/solr/SYSTEM_REQUIREMENTS.txt:r953476-1097796
  Merged /lucene/java/branches/lucene_2_9/solr/SYSTEM_REQUIREMENTS.txt:r817269-818600,825998,829134,829881,831036,896850,909334
  Merged /lucene/dev/branches/lucene3622/solr/SYSTEM_REQUIREMENTS.txt:r1211241-1213825
  Merged /lucene/dev/branches/lucene3606/solr/SYSTEM_REQUIREMENTS.txt:r1209906-1212022
  Merged /lucene/dev/branches/solr2452/solr/SYSTEM_REQUIREMENTS.txt:r1087601-1144716
  Merged /lucene/java/branches/lucene_2_9_back_compat_tests/solr/SYSTEM_REQUIREMENTS.txt:r818601-821336
  Merged /lucene/dev/branches/lucene4446/solr/SYSTEM_REQUIREMENTS.txt:r1397400-1398082
  Merged /lucene/dev/branches/solr3733/solr/SYSTEM_REQUIREMENTS.txt:r1388080-1388269
  Merged /lucene/dev/branches/lucene4547/solr/SYSTEM_REQUIREMENTS.txt:r1407149-1443597
  Merged /lucene/dev/branches/LUCENE2793/solr/SYSTEM_REQUIREMENTS.txt:r1137551-1144189
  Merged /lucene/dev/branches/lucene3846/solr/SYSTEM_REQUIREMENTS.txt:r1397170-1403761
  Merged /lucene/solr/trunk/SYSTEM_REQUIREMENTS.txt:r922950-923910,923912-925091
  Merged /lucene/dev/branches/lucene4765/solr/SYSTEM_REQUIREMENTS.txt:r1444646-1447981
  Merged /lucene/dev/branches/lucene2858/solr/SYSTEM_REQUIREMENTS.txt:r1234440-1238051
  Merged /lucene/dev/branches/lucene4199/solr/SYSTEM_REQUIREMENTS.txt:r1358548-1359191
  Merged /lucene/dev/branches/lucene3969/solr/SYSTEM_REQUIREMENTS.txt:r1311219-1324948
  Merged /lucene/dev/branches/branch_4x/solr/licenses:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/test-framework:r1484887
  Merged /lucene/dev/branches/lucene2858/solr/README.txt:r1234440-1238051
  Merged /lucene/dev/branches/lucene4199/solr/README.txt:r1358548-1359191
  Merged /lucene/dev/branches/lucene3969/solr/README.txt:r1311219-1324948
  Merged /lucene/dev/branches/branch_4x/solr/README.txt:r1349991,1359358,1367833,1368975,1369231,1378442,1390137,1449183,1467413,1468482,1468511,1468522,1468638,1476857,1478854,1484887
  Merged /lucene/dev/branches/lucene_solr_4_0/solr/README.txt:r1388937,1389448,1390046,1390136
  Merged /lucene/dev/branches/lucene_solr_3_1/solr/README.txt:r1081856,1083239,1085499,1085511,1085532,1085809,1101103
  Merged /lucene/dev/branches/lucene_solr_4_1/solr/README.txt:r1434389
  Merged /lucene/dev/branches/lucene_solr_3_2/solr/README.txt:r1128223,1128247,1129418,1129472
  Merged /lucene/dev/branches/lucene_solr_3_3/solr/README.txt:r1138390,1138979,1139775
  Merged /lucene/solr/branches/newtrunk/solr/README.txt:r924462
  Merged /lucene/dev/branches/lucene3312/solr/README.txt:r1357905-1379945
  Merged /lucene/dev/branches/docvalues/solr/README.txt:r1021634-1134288
  Merged /lucene/dev/branches/lucene2621/solr/README.txt:r1188713-1197598,1197605-1199706,1199787-1202835
  Merged /lucene/java/branches/lucene_2_9_back_compat_tests/solr/README.txt:r818601-821336
  Merged /lucene/dev/branches/lucene4446/solr/README.txt:r1397400-1398082
  Merged /lucene/dev/branches/solr3733/solr/README.txt:r1388080-1388269
  Merged /lucene/dev/branches/lucene4547/solr/README.txt:r1407149-1443597
  Merged /lucene/dev/branches/lucene4765/solr/README.txt:r1444646-1447981
  Merged /lucene/dev/branches/lucene3795_lsp_spatial_module/solr/README.txt:r1291491-1300396
  Merged /lucene/dev/branches/preflexfixes/solr/README.txt:r967125-979432
  Merged /lucene/dev/branches/branch_3x/solr/README.txt:r949730,961612,979161,980654,982195,987811,988512,1025544,1026614,1034080,1039151,1050654,1056762,1060014,1060438,1060784,1061035,1063880,1063934,1065324,1070818,1075044,1079376,1079381,1080071,1081052,1083240,1085811,1090423,1091501,1092373,1095519,1098770,1099210,1100407,1100480,1100494,1100515,1101106,1103086,1128215,1128227,1128462,1129419,1129435,1130612,1132581,1132978,1134823,1134917,1136714,1138351,1139430,1139461,1141060,1144653,1148611,1148849,1148864,1150434,1151830,1151947,1152766,1166791,1171384,1173311,1173701,1173745,1177994,1184955,1188805,1189914,1189969,1198337,1199847,1204494,1204519,1204547,1204565,1204826,1207010,1208375,1226235,1229268,1230429,1232954,1234450,1235713,1244960,1302703,1302733,1302749,1302808,1303269,1303733,1304295,1304360,1304660,1304904,1305074,1305574,1305585,1305622,1305681,1305693,1305741,1306929,1310314
  Merged /lucene/java/branches/lucene_3_0/solr/README.txt:r880793,896906
  Merged /lucene/dev/branches/cleanup2878/solr/README.txt:r1403701-1403781
  Merged /lucene/java/branches/lucene_2_4/solr/README.txt:r748824
  Merged /lucene/dev/branches/lucene2510/solr/README.txt:r1364862-1365496
  Merged /lucene/dev/branches/bulkpostings/solr/README.txt:r1069647,1069925
  Merged /lucene/java/branches/lucene_2_9/solr/README.txt:r817269-818600,825998,829134,829881,831036,896850,909334
  Merged /lucene/dev/branches/realtime_search/solr/README.txt:r953476-1097796
  Merged /lucene/dev/branches/lucene3622/solr/README.txt:r1211241-1213825
  Merged /lucene/dev/branches/pforcodec_3892/solr/README.txt:r1352188-1375470
  Merged /lucene/dev/branches/lucene4055/solr/README.txt:r1338960-1343359
  Merged /lucene/dev/branches/lucene3606/solr/README.txt:r1209906-1212022
  Merged /lucene/dev/branches/lucene3661/solr/README.txt:r1233476-1237242,1237250-1238012
  Merged /lucene/dev/branches/solr2452/solr/README.txt:r1087601-1144716
  Merged /lucene/solr/trunk/README.txt:r922950-923910,923912-925091
  Merged /lucene/dev/branches/lucene3846/solr/README.txt:r1397170-1403761
  Merged /lucene/dev/branches/LUCENE2793/solr/README.txt:r1137551-1144189
  Merged /lucene/dev/branches/branch_4x/solr/webapp:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/cloud-dev:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/common-build.xml:r1484887
  Merged /lucene/dev/branches/branch_4x/solr/CHANGES.txt:r1484887
  Merged /lucene/java/branches/lucene_3_0/solr/scripts:r880793,896906
  Merged /lucene/dev/branches/bulkpostings/solr/scripts:r1069647,1069925
  Merged /lucene/dev/branches/realtime_search/solr/scripts:r953476-1097796
  Merged /lucene/java/branches/lucene_2_9/solr/scripts:r817269-818600,825998,829134,829881,831036,896850,909334
  Merged /lucene/dev/branches/lucene3622/solr/scripts:r1211241-1213825
  Merged /lucene/dev/branches/lucene3606/solr/scripts:r1209906-1212022
  Merged /lucene/dev/branches/solr2452/solr/scripts:r1087601-1144716
  Merged /lucene/java/branches/lucene_2_9_back_compat_tests/solr/scripts:r818601-821336
  Merged /lucene/dev/branches/lucene4446/solr/scripts:r1397400-1398082
  Merged /lucene/dev/branches/solr3733/solr/scripts:r1388080-1388269
  Merged /lucene/dev/branches/lucene4547/solr/scripts:r1407149-1443597
  Merged /lucene/dev/branches/LUCENE2793/solr/scripts:r1137551-1144189
  Merged /lucene/dev/branches/lucene3846/solr/scripts:r1397170-1403761
  Merged /lucene/solr/trunk/scripts:r922950-923910,923912-925091
  Merged /lucene/dev/branches/lucene4765/solr/scripts:r1444646-1447981
  Merged /lucene/dev/branches/lucene2858/solr/scripts:r1234440-1238051
  Merged /lucene/dev/branches/lucene4199/solr/scripts:r1358548-1359191
  Merged /lucene/dev/branches/lucene3969/solr/scripts:r1311219-1324948
  Merged /lucene/dev/branches/lucene_solr_3_2/solr/scripts:r1128223,1128247,1129418,1129472
  Merged /lucene/dev/branches/lucene_solr_4_1/solr/scripts:r1434389
  Merged /lucene/dev/branches/cleanup2878/solr/scripts:r1403701-1403781
  Merged /lucene/java/branches/lucene_2_4/solr/scripts:r748824
  Merged /lucene/dev/branches/lucene2510/solr/scripts:r1364862-1365496
  Merged /lucene/dev/branches/lucene3312/solr/scripts:r1357905-1379945
  Merged /lucene/dev/branches/docvalues/solr/scripts:r1021634-1134288
  Merged /lucene/dev/branches/lucene2621/solr/scripts:r1188713-1197598,1197605-1199706,1199787-1202835
  Merged /lucene/dev/branches/lucene4055/solr/scripts:r1338960-1343359
  Merged /lucene/dev/branches/pforcodec_3892/solr/scripts:r1352188-1375470
  Merged /lucene/dev/branches/lucene3661/solr/scripts:r1233476-1237242,1237250-1238012
  Merged /lucene/dev/branches/lucene3795_lsp_spatial_module/solr/scripts:r1291491-1300396
  Merged /lucene/dev/branches/preflexfixes/solr/scripts:r967125-979432
  Merged /lucene/dev/branches/branch_3x/solr/scripts:r949730,961612,979161,980654,982195,987811,988512,1025544,1026614,1034080,1039151,1050654,1056762,1060014,1060438,1060784,1061035,1063880,1063934,1065324,1070818,1075044,1079376,1079381,1080071,1081052,1083240,1085811,1090423,1091501,1092373,1095519,1098770,1099210,1100407,1100480,1100494,1100515,1101106,1103086,1128215,1128227,1128462,1129419,1129435,1130612,1132581,1132978,1134823,1134917,1136714,1138351,1139430,1139461,1141060,1144653,1148611,1148849,1148864,1150434,1151830,1151947,1152766,1166791,1171384,1173311,1173701,1173745,1177994,1184955,1188805,1189914,1189969,1198337,1199847,1204494,1204519,1204547,1204565,1204826,1207010,1208375,1226235,1229268,1230429,1232954,1234450,1235713,1244960,1302703,1302733,1302749,1302808,1303269,1303733,1304295,1304360,1304660,1304904,1305074,1305574,1305585,1305622,1305681,1305693,1305741,1306929,1310314
  Merged /lucene/dev/branches/branch_4x/solr/scripts:r1349991,1359358,1367833,1368975,1369231,1378442,1390137,1449183,1467413,1468482,1468511,1468522,1468638,1476857,1478854,1484887
  Merged /lucene/dev/branches/lucene_solr_4_0/solr/scripts:r1388937,1389448,1390046,1390136
  Merged /lucene/dev/branches/lucene_solr_3_1/solr/scripts:r1081856,1083239,1085499,1085511,1085532,1085809,1101103
  Merged /lucene/dev/branches/lucene_solr_3_3/solr/scripts:r1138390,1138979,1139775
  Merged /lucene/solr/branches/newtrunk/solr/scripts:r924462
/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.solr.request;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Random;

import org.apache.lucene.index.DocTermOrds;
import org.apache.lucene.index.Term;
import org.apache.lucene.index.TermsEnum;
import org.apache.lucene.util.BytesRef;
import org.apache.solr.SolrTestCaseJ4;
import org.apache.solr.common.params.FacetParams;
import org.junit.After;
import org.junit.BeforeClass;
import org.junit.Test;

/**
 *
 */
public class TestFaceting extends SolrTestCaseJ4 {
  @BeforeClass
  public static void beforeClass() throws Exception {
    initCore("solrconfig.xml","schema11.xml");
  }

  @Override
  public void setUp() throws Exception {
    super.setUp();
    clearIndex();
  }

  @After
  @Override
  public void tearDown() throws Exception {
    close();
    super.tearDown();
  }

  String t(int tnum) {
    return String.format(Locale.ROOT, "%08d", tnum);
  }
  
  void createIndex(int nTerms) {
    assertU(delQ("*:*"));
    for (int i=0; i<nTerms; i++) {
      assertU(adoc("id", Float.toString(i), proto.field(), t(i) ));
    }
    assertU(optimize()); // squeeze out any possible deleted docs
  }

  Term proto = new Term("field_s","");
  SolrQueryRequest req; // used to get a searcher
  void close() {
    if (req!=null) req.close();
    req = null;
  }

  void doTermEnum(int size) throws Exception {
    //System.out.println("doTermEnum size=" + size);
    close();
    createIndex(size);
    req = lrf.makeRequest("q","*:*");

    UnInvertedField uif = new UnInvertedField(proto.field(), req.getSearcher());

    assertEquals(size, uif.getNumTerms());

    TermsEnum te = uif.getOrdTermsEnum(req.getSearcher().getAtomicReader());
    assertEquals(size == 0, te == null);

    Random r = new Random(size);
    // test seeking by term string
    for (int i=0; i<size*2+10; i++) {
      int rnum = r.nextInt(size+2);
      String s = t(rnum);
      //System.out.println("s=" + s);
      final BytesRef br;
      if (te == null) {
        br = null;
      } else {
        TermsEnum.SeekStatus status = te.seekCeil(new BytesRef(s));
        if (status == TermsEnum.SeekStatus.END) {
          br = null;
        } else {
          br = te.term();
        }
      }
      assertEquals(br != null, rnum < size);
      if (rnum < size) {
        assertEquals(rnum, (int) te.ord());
        assertEquals(s, te.term().utf8ToString());
      }
    }

    // test seeking before term
    if (size>0) {
      assertEquals(size>0, te.seekCeil(new BytesRef("000"), true) != TermsEnum.SeekStatus.END);
      assertEquals(0, te.ord());
      assertEquals(t(0), te.term().utf8ToString());
    }

    if (size>0) {
      // test seeking by term number
      for (int i=0; i<size*2+10; i++) {
        int rnum = r.nextInt(size);
        String s = t(rnum);
        te.seekExact((long) rnum);
        BytesRef br = te.term();
        assertNotNull(br);
        assertEquals(rnum, (int) te.ord());
        assertEquals(s, te.term().utf8ToString());
      }
    }
  }

  @Test
  public void testTermEnum() throws Exception {
    doTermEnum(0);
    doTermEnum(1);
    final int DEFAULT_INDEX_INTERVAL = 1 << DocTermOrds.DEFAULT_INDEX_INTERVAL_BITS;
    doTermEnum(DEFAULT_INDEX_INTERVAL - 1);  // test boundaries around the block size
    doTermEnum(DEFAULT_INDEX_INTERVAL);
    doTermEnum(DEFAULT_INDEX_INTERVAL + 1);
    doTermEnum(DEFAULT_INDEX_INTERVAL * 2 + 2);    
    // doTermEnum(DEFAULT_INDEX_INTERVAL * 3 + 3);    
  }

  @Test
  public void testFacets() throws Exception {
    StringBuilder sb = new StringBuilder();

    // go over 4096 to test some of the buffer resizing
    for (int i=0; i<5000; i++) {
      sb.append(t(i));
      sb.append(' ');     
    }

    assertU(adoc("id", "1", "many_ws", sb.toString()));
    assertU(commit());

    assertQ("check many tokens",
            req("q", "id:1","indent","true"
                ,"facet", "true", "facet.method","fc"
                ,"facet.field", "many_ws"
                ,"facet.limit", "-1"
                )
            ,"*[count(//lst[@name='many_ws']/int)=5000]"
            ,"//lst[@name='many_ws']/int[@name='" + t(0) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(1) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(2) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(3) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(5) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4092) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4093) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4094) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4095) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4096) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4097) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4098) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4090) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4999) + "'][.='1']"
            );

    // test gaps that take more than one byte
    sb = new StringBuilder();
    sb.append(t(0)).append(' ');
    sb.append(t(150)).append(' ');
    sb.append(t(301)).append(' ');
    sb.append(t(453)).append(' ');
    sb.append(t(606)).append(' ');
    sb.append(t(1000)).append(' ');
    sb.append(t(2010)).append(' ');
    sb.append(t(3050)).append(' ');
    sb.append(t(4999)).append(' ');
    assertU(adoc("id", "2", "many_ws", sb.toString()));
    assertQ("check many tokens",
            req("q", "id:1","indent","true"
                ,"facet", "true", "facet.method","fc"
                ,"facet.field", "many_ws"
                ,"facet.limit", "-1"
                )
            ,"*[count(//lst[@name='many_ws']/int)=5000]"
            ,"//lst[@name='many_ws']/int[@name='" + t(0) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(150) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(301) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(453) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(606) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(1000) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(2010) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(3050) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(4999) + "'][.='1']"
              );
  }

  @Test
  public void testRegularBig() throws Exception {
    StringBuilder sb = new StringBuilder();

    // go over 4096 to test some of the buffer resizing
    int nTerms=7;
    for (int i=0; i<nTerms; i++) {
      sb.append(t(i));
      sb.append(' ');
    }

    int i1=1000000;

    // int iter=65536+10;
    int iter=1000;
    int commitInterval=iter/9;

    for (int i=0; i<iter; i++) {
      // assertU(adoc("id", t(i), "many_ws", many_ws + t(i1+i) + " " + t(i1*2+i)));
      assertU(adoc("id", t(i), "many_ws", t(i1+i) + " " + t(i1*2+i)));
      if (iter % commitInterval == 0) {
        assertU(commit());
      }
    }
    assertU(commit());

    for (int i=0; i<iter; i+=iter/10) {
    assertQ("check many tokens",
            req("q", "id:"+t(i),"indent","true"
                ,"facet", "true", "facet.method","fc"
                ,"facet.field", "many_ws"
                ,"facet.limit", "-1"
                ,"facet.mincount", "1"
                )
            ,"*[count(//lst[@name='many_ws']/int)=" + 2 + "]"
            ,"//lst[@name='many_ws']/int[@name='" + t(i1+i) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(i1*2+i) + "'][.='1']"
            );
    }

    int i=iter-1;
    assertQ("check many tokens",
            req("q", "id:"+t(i),"indent","true"
                ,"facet", "true", "facet.method","fc"
                ,"facet.field", "many_ws"
                ,"facet.limit", "-1"
                ,"facet.mincount", "1"

                )
            ,"*[count(//lst[@name='many_ws']/int)=" + 2 + "]"
            ,"//lst[@name='many_ws']/int[@name='" + t(i1+i) + "'][.='1']"
            ,"//lst[@name='many_ws']/int[@name='" + t(i1*2+i) + "'][.='1']"
            );
  }

  @Test
  public void testTrieFields() {
    // make sure that terms are correctly filtered even for trie fields that index several
    // terms for a single value
    List<String> fields = new ArrayList<String>();
    fields.add("id");
    fields.add("7");
    final String[] suffixes = new String[] {"ti", "tis", "tf", "tfs", "tl", "tls", "td", "tds"};
    for (String suffix : suffixes) {
      fields.add("f_" + suffix);
      fields.add("42");
    }
    assertU(adoc(fields.toArray(new String[0])));
    assertU(commit());
    for (String suffix : suffixes) {
      for (String facetMethod : new String[] {FacetParams.FACET_METHOD_enum, FacetParams.FACET_METHOD_fc, FacetParams.FACET_METHOD_fcs}) {
        for (String facetSort : new String[] {FacetParams.FACET_SORT_COUNT, FacetParams.FACET_SORT_INDEX}) {
          for (String value : new String[] {"42", "43"}) { // match or not
            final String field = "f_" + suffix;
            assertQ("field=" + field + ",method=" + facetMethod + ",sort=" + facetSort,
                req("q", field + ":" + value, FacetParams.FACET, "true", FacetParams.FACET_FIELD, field, FacetParams.FACET_MINCOUNT, "0", FacetParams.FACET_SORT, facetSort, FacetParams.FACET_METHOD, facetMethod),
                "*[count(//lst[@name='" + field + "']/int)=1]"); // exactly 1 facet count
          }
        }
      }
    }
  }

  @Test
  public void testFacetSortWithMinCount() {
    assertU(adoc("id", "1.0", "f_td", "-420.126"));
    assertU(adoc("id", "2.0", "f_td", "-285.672"));
    assertU(adoc("id", "3.0", "f_td", "-1.218"));
    assertU(commit());

    assertQ(req("q", "*:*", FacetParams.FACET, "true", FacetParams.FACET_FIELD, "f_td", "f.f_td.facet.sort", FacetParams.FACET_SORT_INDEX),
        "*[count(//lst[@name='f_td']/int)=3]",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[1][@name='-420.126']",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[2][@name='-285.672']",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[3][@name='-1.218']");

    assertQ(req("q", "*:*", FacetParams.FACET, "true", FacetParams.FACET_FIELD, "f_td", "f.f_td.facet.sort", FacetParams.FACET_SORT_INDEX, FacetParams.FACET_MINCOUNT, "1", FacetParams.FACET_METHOD, FacetParams.FACET_METHOD_fc),
        "*[count(//lst[@name='f_td']/int)=3]",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[1][@name='-420.126']",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[2][@name='-285.672']",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[3][@name='-1.218']");

    assertQ(req("q", "*:*", FacetParams.FACET, "true", FacetParams.FACET_FIELD, "f_td", "f.f_td.facet.sort", FacetParams.FACET_SORT_INDEX, FacetParams.FACET_MINCOUNT, "1", "indent","true"),
        "*[count(//lst[@name='f_td']/int)=3]",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[1][@name='-420.126']",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[2][@name='-285.672']",
        "//lst[@name='facet_fields']/lst[@name='f_td']/int[3][@name='-1.218']");
  }



  public void testDateFacetsWithMultipleConfigurationForSameField() {
    clearIndex();
    final String f = "bday_dt";

    assertU(adoc("id", "1",  f, "1976-07-04T12:08:56.235Z"));
    assertU(adoc("id", "2",  f, "1976-07-05T00:00:00.000Z"));
    assertU(adoc("id", "3",  f, "1976-07-15T00:07:67.890Z"));
    assertU(commit());
    assertU(adoc("id", "4",  f, "1976-07-21T00:07:67.890Z"));
    assertU(adoc("id", "5",  f, "1976-07-13T12:12:25.255Z"));
    assertU(adoc("id", "6",  f, "1976-07-03T17:01:23.456Z"));
    assertU(adoc("id", "7",  f, "1976-07-12T12:12:25.255Z"));
    assertU(adoc("id", "8",  f, "1976-07-15T15:15:15.155Z"));
    assertU(adoc("id", "9",  f, "1907-07-12T13:13:23.235Z"));
    assertU(adoc("id", "10", f, "1976-07-03T11:02:45.678Z"));
    assertU(commit());
    assertU(adoc("id", "11", f, "1907-07-12T12:12:25.255Z"));
    assertU(adoc("id", "12", f, "2007-07-30T07:07:07.070Z"));
    assertU(adoc("id", "13", f, "1976-07-30T22:22:22.222Z"));
    assertU(adoc("id", "14", f, "1976-07-05T22:22:22.222Z"));
    assertU(commit());

    final String preFoo = "//lst[@name='facet_dates']/lst[@name='foo']";
    final String preBar = "//lst[@name='facet_dates']/lst[@name='bar']";

    assertQ("check counts for month of facet by day",
            req( "q", "*:*"
                ,"rows", "0"
                ,"facet", "true"
                ,"facet.date", "{!key=foo " +
                  "facet.date.start=1976-07-01T00:00:00.000Z " +
                  "facet.date.end=1976-07-01T00:00:00.000Z+1MONTH " +
                  "facet.date.gap=+1DAY " +
                  "facet.date.other=all " +
                "}" + f
                ,"facet.date", "{!key=bar " +
                  "facet.date.start=1976-07-01T00:00:00.000Z " +
                  "facet.date.end=1976-07-01T00:00:00.000Z+7DAY " +
                  "facet.date.gap=+1DAY " +
                "}" + f
              )
            // 31 days + pre+post+inner = 34
            ,"*[count("+preFoo+"/int)=34]"
            ,preFoo+"/int[@name='1976-07-01T00:00:00Z'][.='0'  ]"
            ,preFoo+"/int[@name='1976-07-02T00:00:00Z'][.='0'  ]"
            ,preFoo+"/int[@name='1976-07-03T00:00:00Z'][.='2'  ]"
            // july4th = 2 because exists doc @ 00:00:00.000 on July5
            // (date faceting is inclusive)
            ,preFoo+"/int[@name='1976-07-04T00:00:00Z'][.='2'  ]"
            ,preFoo+"/int[@name='1976-07-05T00:00:00Z'][.='2'  ]"
            ,preFoo+"/int[@name='1976-07-06T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-07T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-08T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-09T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-10T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-11T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-12T00:00:00Z'][.='1'  ]"
            ,preFoo+"/int[@name='1976-07-13T00:00:00Z'][.='1'  ]"
            ,preFoo+"/int[@name='1976-07-14T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-15T00:00:00Z'][.='2'  ]"
            ,preFoo+"/int[@name='1976-07-16T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-17T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-18T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-19T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-21T00:00:00Z'][.='1'  ]"
            ,preFoo+"/int[@name='1976-07-22T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-23T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-24T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-25T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-26T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-27T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-28T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-29T00:00:00Z'][.='0']"
            ,preFoo+"/int[@name='1976-07-30T00:00:00Z'][.='1'  ]"
            ,preFoo+"/int[@name='1976-07-31T00:00:00Z'][.='0']"

            ,preFoo+"/int[@name='before' ][.='2']"
            ,preFoo+"/int[@name='after'  ][.='1']"
            ,preFoo+"/int[@name='between'][.='11']"

            ,"*[count("+preBar+"/int)=7]"
            ,preBar+"/int[@name='1976-07-01T00:00:00Z'][.='0'  ]"
            ,preBar+"/int[@name='1976-07-02T00:00:00Z'][.='0'  ]"
            ,preBar+"/int[@name='1976-07-03T00:00:00Z'][.='2'  ]"
            // july4th = 2 because exists doc @ 00:00:00.000 on July5
            // (date faceting is inclusive)
            ,preBar+"/int[@name='1976-07-04T00:00:00Z'][.='2'  ]"
            ,preBar+"/int[@name='1976-07-05T00:00:00Z'][.='2'  ]"
            ,preBar+"/int[@name='1976-07-06T00:00:00Z'][.='0']"
            ,preBar+"/int[@name='1976-07-07T00:00:00Z'][.='0']"
              );

      clearIndex();
      assertU(commit());
    }

    public void testSimpleFacetCountsWithMultipleConfigurationsForSameField() {
      clearIndex();
      String fname = "trait_ss";
      assertU(adoc("id", "42",
          fname, "Tool",
          fname, "Obnoxious",
          "name_s", "Zapp Brannigan"));

      assertU(adoc("id", "43" ,
                   "title_s", "Democratic Order of Planets"));
      assertU(commit());
  
      assertU(adoc("id", "44",
          fname, "Tool",
          "name_s", "The Zapper"));
  
      assertU(adoc("id", "45",
          fname, "Chauvinist",
          "title_s", "25 star General"));
  
      assertU(adoc("id", "46",
          fname, "Obnoxious",
          "subject_s", "Defeated the pacifists of the Gandhi nebula"));
  
      assertU(commit());
  
      assertU(adoc("id", "47",
          fname, "Pig",
          "text_t", "line up and fly directly at the enemy death cannons, clogging them with wreckage!"));
      assertU(commit());
  
      assertQ("checking facets when one has missing=true&mincount=2 and the other has missing=false&mincount=0",
              req("q", "id:[42 TO 47]"
                  ,"facet", "true"
                  ,"facet.zeros", "false"
                  ,"fq", "id:[42 TO 45]"
                  ,"facet.field", "{!key=foo " +
                     "facet.mincount=0 "+
                     "facet.missing=false "+
                  "}"+fname
                  ,"facet.field", "{!key=bar " +
                     "facet.mincount=2 "+
                     "facet.missing=true "+
                  "}"+fname
                  )
              ,"*[count(//doc)=4]"
              ,"*[count(//lst[@name='foo']/int)=4]"
              ,"*[count(//lst[@name='bar']/int)=2]"
              ,"//lst[@name='foo']/int[@name='Tool'][.='2']"
              ,"//lst[@name='foo']/int[@name='Obnoxious'][.='1']"
              ,"//lst[@name='foo']/int[@name='Chauvinist'][.='1']"
              ,"//lst[@name='foo']/int[@name='Pig'][.='0']"
              ,"//lst[@name='foo']/int[@name='Tool'][.='2']"
              ,"//lst[@name='bar']/int[not(@name)][.='1']"
              );
  
      assertQ("checking facets when one has missing=true&mincount=2 and the other has missing=false&mincount=0",
              req("q", "id:[42 TO 47]"
                  ,"facet", "true"
                  ,"facet.zeros", "false"
                  ,"fq", "id:[42 TO 45]"
                  ,"facet.field", "{!key=foo " +
                      "facet.prefix=Too "+
                  "}"+fname
                  ,"facet.field", "{!key=bar " +
                      "facet.limit=2 "+
                      "facet.sort=false "+
                  "}"+fname
                  )
              ,"*[count(//doc)=4]"
              ,"*[count(//lst[@name='foo']/int)=1]"
              ,"*[count(//lst[@name='bar']/int)=2]"
              ,"//lst[@name='foo']/int[@name='Tool'][.='2']"
              ,"//lst[@name='bar']/int[@name='Chauvinist'][.='1']"
              ,"//lst[@name='bar']/int[@name='Obnoxious'][.='1']"
              );

      assertQ("localparams in one facet variant should not affect defaults in another: facet.sort vs facet.missing",
                  req("q", "id:[42 TO 47]"
                          ,"rows","0"
                          ,"facet", "true"
                          ,"fq", "id:[42 TO 45]"
                          ,"facet.field", "{!key=foo " +
                              "facet.sort=index" +
                          "}"+fname
                          ,"facet.field", "{!key=bar " +
                              "facet.missing=true" +
                          "}"+fname
                          )
                      // foo is in index order w/o missing
                      ,"*[count(//lst[@name='foo']/int)=4]"
                  ,"//lst[@name='foo']/int[1][@name='Chauvinist'][.='1']"
                  ,"//lst[@name='foo']/int[2][@name='Obnoxious'][.='1']"
                  ,"//lst[@name='foo']/int[3][@name='Pig'][.='0']"
                  ,"//lst[@name='foo']/int[4][@name='Tool'][.='2']"
                  // bar is in count order by default and includes missing
                  ,"*[count(//lst[@name='bar']/int)=5]"
                  ,"//lst[@name='bar']/int[1][@name='Tool'][.='2']"
                  // don't assume tie breaker for slots 3 & 4, behavior undefined?
                  ,"//lst[@name='bar']/int[4][@name='Pig'][.='0']"
                  ,"//lst[@name='bar']/int[5][not(@name)][.='1']"
                  );

      assertQ("localparams in one facet variant should not affect defaults in another: facet.mincount",
                  req("q", "id:[42 TO 47]"
                          ,"rows","0"
                          ,"facet", "true"
                          ,"fq", "id:[42 TO 45]"
                          ,"facet.field", "{!key=foo " +
                              "facet.mincount=2" +
                          "}"+fname
                          ,"facet.field", "{!key=bar}"+fname
                          )
                      // only Tool for foo
                      ,"*[count(//lst[@name='foo']/int)=1]"
                  ,"//lst[@name='foo']/int[1][@name='Tool'][.='2']"
                  // all for bar
                  ,"*[count(//lst[@name='bar']/int)=4]"
                  ,"//lst[@name='bar']/int[1][@name='Tool'][.='2']"
                  // don't assume tie breaker for slots 3 & 4, behavior undefined?
                  ,"//lst[@name='bar']/int[4][@name='Pig'][.='0']"
                  );

      assertQ("localparams in one facet variant should not affect defaults in another: facet.missing",
                  req("q", "id:[42 TO 47]"
                          ,"rows","0"
                          ,"facet", "true"
                          ,"fq", "id:[42 TO 45]"
                          ,"facet.field", "{!key=foo " +
                              "facet.missing=true" +
                          "}"+fname
                          ,"facet.field", "{!key=bar}"+fname
                          )
                      // foo includes missing
                      ,"*[count(//lst[@name='foo']/int)=5]"
                  ,"//lst[@name='foo']/int[1][@name='Tool'][.='2']"
                  // don't assume tie breaker for slots 3 & 4, behavior undefined?
                  ,"//lst[@name='foo']/int[4][@name='Pig'][.='0']"
                  ,"//lst[@name='foo']/int[5][not(@name)][.='1']"
                  // bar does not
                  ,"*[count(//lst[@name='bar']/int)=4]"
                  ,"//lst[@name='bar']/int[1][@name='Tool'][.='2']"
                  // don't assume tie breaker for slots 3 & 4, behavior undefined?
                  ,"//lst[@name='bar']/int[4][@name='Pig'][.='0']"
                  );

      assertQ("checking facets when local facet.prefix param used after regular/raw field faceting",
          req("q", "*:*"
              ,"facet", "true"
              ,"facet.field", fname
              ,"facet.field", "{!key=foo " +
              "facet.prefix=T "+
              "}"+fname
          )
          ,"*[count(//doc)=6]"
          ,"*[count(//lst[@name='" + fname + "']/int)=4]"
          ,"*[count(//lst[@name='foo']/int)=1]"
          ,"//lst[@name='foo']/int[@name='Tool'][.='2']"
      );

      assertQ("checking facets when local facet.prefix param used before regular/raw field faceting",
          req("q", "*:*"
              ,"facet", "true"
              ,"facet.field", "{!key=foo " +
              "facet.prefix=T "+
              "}"+fname
              ,"facet.field", fname
          )
          ,"*[count(//doc)=6]"
          ,"*[count(//lst[@name='" + fname + "']/int)=4]"
          ,"*[count(//lst[@name='foo']/int)=1]"
          ,"//lst[@name='foo']/int[@name='Tool'][.='2']"
      );

      clearIndex();
      assertU(commit());
  }
}

